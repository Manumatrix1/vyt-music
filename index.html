<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Entradas VYTMUSIC</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Mover la configuración de Tailwind después de que el CDN de Tailwind se haya cargado.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button-primary {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .button-primary:hover {
            background-color: #4f46e5; /* Indigo 600 */
        }
        .button-secondary {
            background-color: #e0e7ff; /* Indigo 100 */
            color: #4f46e5; /* Indigo 600 */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .button-secondary:hover {
            background-color: #c7d2fe; /* Indigo 200 */
        }
        .section-header {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* Gray 900 */
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* Gray 300 */
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        /* Style for QR code container */
        .qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background-color: #f9fafb; /* Gray 50 */
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            min-height: 200px; /* Ensure visibility even if QR is small */
        }
        .qrcode-container img {
            max-width: 100%;
            height: auto;
        }

        /* QR Scanner specific styles */
        #reader {
            width: 100%;
            max-width: 400px; /* Limit scanner width for better aspect ratio */
            margin: 0 auto;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            overflow: hidden; /* Hide any overflow from the scanner component */
            position: relative; /* For video/canvas positioning */
            min-height: 300px; /* Ensure scanner area is visible */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #333; /* Dark background for scanner area */
        }
        #video-preview {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover; /* Cover the area, cropping if necessary */
        }
        #qr-canvas {
            position: absolute; /* Overlay canvas on video */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* Hidden canvas for processing frames, will be shown for drawing */
        }
        #scanned-result, #ticket-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
        }
        .status-valid {
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
        }
        .status-used {
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 800 */
        }
        .status-invalid {
            background-color: #fef3c7; /* Yellow 100 */
            color: #92400e; /* Yellow 800 */
        }
        .hidden {
            display: none;
        }
        .ticket-card {
            border: 1px solid #e5e7eb; /* Gray 200 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background-color: #f9fafb; /* Gray 50 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* For checkbox positioning */
        }
        .share-button {
            background-color: #10b981; /* Emerald 500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            cursor: pointer;
            margin-top: 1rem;
        }
        .share-button:hover {
            background-color: #059669; /* Emerald 600 */
        }
        .checkbox-container {
            position: absolute;
            top: 10px;
            left: 10px;
        }
        .batch-action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body class="font-inter antialiased">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-6">VYTMUSIC</h1>
        <p class="text-lg text-center text-gray-600 mb-8">Sistema de Control de Entradas con QR</p>

        <!-- Navigation Buttons -->
        <div class="flex justify-center flex-wrap gap-4 mb-8">
            <button id="show-generator-btn" class="button-primary">Generar Entrada Individual</button>
            <button id="show-batch-generator-btn" class="button-secondary">Generar Múltiples Entradas</button>
            <button id="show-scanner-btn" class="button-secondary">Escanear Entrada</button>
        </div>

        <!-- Ticket Generator Section (Individual) -->
        <div id="ticket-generator-section" class="p-6 border border-gray-200 rounded-lg shadow-sm">
            <h2 class="section-header">Generar Nueva Entrada Individual</h2>
            <div class="mb-4">
                <label for="ticket-holder-name" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Titular:</label>
                <input type="text" id="ticket-holder-name" class="input-field" placeholder="Ej: Juan Pérez">
            </div>
            <button id="generate-ticket-btn" class="button-primary w-full">Generar Entrada QR</button>

            <div id="generated-ticket-info" class="mt-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-center hidden">
                <p class="text-indigo-800 font-semibold mb-2">¡Entrada Generada Exitosamente!</p>
                <p class="text-gray-700 text-sm">ID de la Entrada:</p>
                <p id="ticket-id-display" class="text-xl font-bold text-indigo-700 break-words"></p>
                <div id="qrcode-single" class="qrcode-container"></div> <!-- Unique ID for single QR -->
                <button id="share-single-qr-btn" class="share-button">Compartir QR</button>
            </div>
        </div>

        <!-- Batch Ticket Generator Section -->
        <div id="batch-ticket-generator-section" class="p-6 border border-gray-200 rounded-lg shadow-sm hidden">
            <h2 class="section-header">Generar Múltiples Entradas</h2>
            <div class="mb-4">
                <label for="batch-ticket-names" class="block text-gray-700 text-sm font-bold mb-2">Nombres de los Titulares (uno por línea o separados por comas):</label>
                <textarea id="batch-ticket-names" class="input-field h-32" placeholder="Ej:&#10;Mauro&#10;Ana&#10;Carlos&#10;Sofía"></textarea>
            </div>
            <button id="generate-batch-tickets-btn" class="button-primary w-full">Generar Entradas QR por Lotes</button>

            <div id="generated-batch-tickets-info" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-indigo-700 mb-4 text-center">Entradas Generadas:</h3>
                <div class="batch-action-buttons">
                    <button id="select-all-qrs-btn" class="button-secondary">Seleccionar Todos</button>
                    <button id="share-selected-qrs-btn" class="share-button">Compartir Seleccionados</button>
                    <button id="download-selected-qrs-btn" class="button-secondary">Descargar Seleccionados</button>
                </div>
                <div id="batch-qrcodes-display" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                    <!-- QR codes will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- QR Scanner Section -->
        <div id="qr-scanner-section" class="p-6 border border-gray-200 rounded-lg shadow-sm">
            <h2 class="section-header">Escanear Entrada</h2>
            <div id="reader">
                <video id="video-preview" autoplay playsinline></video>
                <canvas id="qr-canvas"></canvas> <!-- Canvas for drawing detection box -->
            </div>
            <div id="scanned-result" class="hidden"></div>
            <div id="ticket-status" class="hidden"></div>
            <button id="mark-used-btn" class="button-primary w-full mt-4 hidden">Marcar como Usada</button>
        </div>
    </div>

    <!-- QR Code Generator Library -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <!-- jsQR Library for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.min.js"></script>
    <!-- JSZip Library for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // In-memory database for tickets (for demonstration purposes only)
        // In a real application, this would be a backend database like Firestore.
        let ticketsDB = {};
        let currentScannedTicketId = null;
        
        let video = document.getElementById('video-preview');
        let canvasElement = document.getElementById('qr-canvas');
        let canvas = canvasElement.getContext('2d');
        let scanning = false;
        let videoStream = null; // To store the media stream

        // Get DOM elements
        const showGeneratorBtn = document.getElementById('show-generator-btn');
        const showBatchGeneratorBtn = document.getElementById('show-batch-generator-btn');
        const showScannerBtn = document.getElementById('show-scanner-btn');

        const ticketGeneratorSection = document.getElementById('ticket-generator-section');
        const batchTicketGeneratorSection = document.getElementById('batch-ticket-generator-section');
        const qrScannerSection = document.getElementById('qr-scanner-section');

        const ticketHolderNameInput = document.getElementById('ticket-holder-name');
        const generateTicketBtn = document.getElementById('generate-ticket-btn');
        const generatedTicketInfo = document.getElementById('generated-ticket-info');
        const ticketIdDisplay = document.getElementById('ticket-id-display');
        const qrcodeSingleDiv = document.getElementById('qrcode-single');
        const shareSingleQrBtn = document.getElementById('share-single-qr-btn'); 

        const batchTicketNamesTextarea = document.getElementById('batch-ticket-names');
        const generateBatchTicketsBtn = document.getElementById('generate-batch-tickets-btn');
        const generatedBatchTicketsInfo = document.getElementById('generated-batch-tickets-info');
        const batchQRCodesDisplay = document.getElementById('batch-qrcodes-display');
        const selectAllQRsBtn = document.getElementById('select-all-qrs-btn'); 
        const shareSelectedQRsBtn = document.getElementById('share-selected-qrs-btn'); 
        const downloadSelectedQRsBtn = document.getElementById('download-selected-qrs-btn'); 

        const scannedResultDiv = document.getElementById('scanned-result');
        const ticketStatusDiv = document.getElementById('ticket-status');
        const markUsedBtn = document.getElementById('mark-used-btn');
        const qrReaderDiv = document.getElementById('reader');

        // Function to hide all sections and stop scanner
        function hideAllSections() {
            ticketGeneratorSection.classList.add('hidden');
            batchTicketGeneratorSection.classList.add('hidden');
            qrScannerSection.classList.add('hidden');
            stopQrScanner(); // Ensure scanner is stopped when switching sections
        }

        // Function to reset button styles
        function resetButtonStyles() {
            showGeneratorBtn.classList.add('button-secondary');
            showGeneratorBtn.classList.remove('button-primary');
            showBatchGeneratorBtn.classList.add('button-secondary');
            showBatchGeneratorBtn.classList.remove('button-primary');
            showScannerBtn.classList.add('button-secondary');
            showScannerBtn.classList.remove('button-primary');
        }

        // Function to switch between sections
        function switchSection(sectionId) {
            hideAllSections();
            resetButtonStyles();

            if (sectionId === 'ticket-generator-section') {
                ticketGeneratorSection.classList.remove('hidden');
                showGeneratorBtn.classList.add('button-primary');
            } else if (sectionId === 'batch-ticket-generator-section') {
                batchTicketGeneratorSection.classList.remove('hidden');
                showBatchGeneratorBtn.classList.add('button-primary');
            } else if (sectionId === 'qr-scanner-section') {
                qrScannerSection.classList.remove('hidden');
                showScannerBtn.classList.add('button-primary');
                startQrScanner(); // Start scanner when switching to scanner section
            }
        }

        // Function to generate a unique ticket ID
        function generateUniqueTicketId() {
            return 'VYTMUSIC-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        // Function to generate a single QR code and update DB
        async function createAndDisplayTicket(name, containerElement, isBatch = false) {
            const ticketId = generateUniqueTicketId();
            
            // Create a temporary div for QR code generation to get the data URL
            const tempQrDiv = document.createElement('div');
            // QRCode library requires a DOM element to render to
            new QRCode(tempQrDiv, {
                text: ticketId,
                width: isBatch ? 150 : 200, // Smaller QR for batch display
                height: isBatch ? 150 : 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Wait for the QR code to be rendered in the temp div
            await new Promise(resolve => setTimeout(resolve, 50)); 

            const qrCanvas = tempQrDiv.querySelector('canvas');
            let qrDataURL = '';
            if (qrCanvas) {
                qrDataURL = qrCanvas.toDataURL('image/png');
            } else {
                const qrImg = tempQrDiv.querySelector('img');
                if (qrImg) {
                    qrDataURL = qrImg.src;
                }
            }
            
            // Store ticket data including the QR image data URL
            ticketsDB[ticketId] = {
                status: 'valid',
                name: name,
                qrDataURL: qrDataURL
            };

            // Clear previous QR code if it's a single generation
            if (containerElement === qrcodeSingleDiv) {
                containerElement.innerHTML = '';
            }

            // Create a new div for the QR code and text
            const ticketCard = document.createElement('div');
            ticketCard.className = 'ticket-card text-center';
            ticketCard.dataset.ticketId = ticketId; // Store ticket ID for selection

            if (isBatch) {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'ticket-checkbox w-5 h-5 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500';
                checkbox.dataset.ticketId = ticketId;
                checkboxContainer.appendChild(checkbox);
                ticketCard.appendChild(checkboxContainer);
            }

            const namePara = document.createElement('p');
            namePara.className = 'text-lg font-semibold text-gray-800 mb-2 mt-4'; // Added mt-4 for checkbox spacing
            namePara.textContent = `Titular: ${name}`;

            const idPara = document.createElement('p');
            idPara.className = 'text-sm text-gray-600 mb-2 break-words';
            idPara.textContent = `ID: ${ticketId}`;

            const qrImage = document.createElement('img');
            qrImage.src = qrDataURL;
            qrImage.alt = `QR Code for ${name}`;
            qrImage.style.width = isBatch ? '150px' : '200px';
            qrImage.style.height = isBatch ? '150px' : '200px';
            qrImage.className = 'mx-auto';

            const shareButton = document.createElement('button');
            shareButton.className = 'share-button';
            shareButton.textContent = 'Compartir QR';
            shareButton.onclick = () => shareQrCode(ticketId);

            ticketCard.appendChild(namePara);
            ticketCard.appendChild(idPara);
            ticketCard.appendChild(qrImage);
            ticketCard.appendChild(shareButton);

            containerElement.appendChild(ticketCard);

            console.log('Ticket generado:', ticketsDB[ticketId]);
            return ticketId; // Return the generated ID
        }

        // Function to handle individual ticket generation
        async function generateIndividualTicket() {
            const ticketHolderName = ticketHolderNameInput.value.trim();
            if (!ticketHolderName) {
                displayMessage('Por favor, ingresa el nombre del titular de la entrada.', 'error');
                return;
            }

            const generatedId = await createAndDisplayTicket(ticketHolderName, qrcodeSingleDiv);
            ticketIdDisplay.textContent = generatedId;
            generatedTicketInfo.classList.remove('hidden');
            ticketHolderNameInput.value = ''; // Clear input after generation
            displayMessage('¡Entrada Generada Exitosamente!', 'success');
        }

        // Function to handle batch ticket generation
        async function generateBatchTickets() {
            const namesInput = batchTicketNamesTextarea.value.trim();
            if (!namesInput) {
                displayMessage('Por favor, ingresa al menos un nombre para generar entradas.', 'error');
                return;
            }

            // Split names by newline or comma, filter empty strings
            const names = namesInput.split(/[\n,]+/).map(name => name.trim()).filter(name => name.length > 0);

            if (names.length === 0) {
                displayMessage('No se encontraron nombres válidos para generar entradas.', 'error');
                return;
            }

            batchQRCodesDisplay.innerHTML = ''; // Clear previous batch QRs
            let generatedCount = 0;

            for (const name of names) { // Use for...of with await
                await createAndDisplayTicket(name, batchQRCodesDisplay, true); // Pass true for isBatch
                generatedCount++;
            }

            generatedBatchTicketsInfo.classList.remove('hidden');
            batchTicketNamesTextarea.value = ''; // Clear textarea
            displayMessage(`¡Se generaron ${generatedCount} entradas exitosamente!`, 'success');
        }

        // Function to share a single QR code
        async function shareQrCode(ticketId) {
            const ticket = ticketsDB[ticketId];
            if (!ticket || !ticket.qrDataURL) {
                displayMessage('Error: QR no encontrado para compartir.', 'error');
                return;
            }

            // Convert data URL to Blob for sharing
            const blob = await (await fetch(ticket.qrDataURL)).blob();
            const file = new File([blob], `${ticket.name}_${ticketId}.png`, { type: 'image/png' });

            if (navigator.share && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: `Entrada VYTMUSIC para ${ticket.name}`,
                        text: `Aquí tienes tu entrada para VYTMUSIC. ID: ${ticketId}`
                    });
                    displayMessage('QR compartido exitosamente.', 'success');
                } catch (error) {
                    console.error('Error al compartir QR:', error);
                    displayMessage('No se pudo compartir el QR. Intenta descargarlo.', 'error');
                    // Fallback to download if sharing fails
                    saveAs(file, `${ticket.name}_${ticketId}.png`);
                }
            } else {
                displayMessage('Tu navegador no soporta la función de compartir. Descargando el QR...', 'info');
                saveAs(file, `${ticket.name}_${ticketId}.png`);
            }
        }

        // Function to select/deselect all checkboxes
        function toggleSelectAllQRs() {
            const checkboxes = document.querySelectorAll('.ticket-checkbox');
            const allSelected = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => {
                cb.checked = !allSelected;
            });
        }

        // Function to share selected QR codes (as a ZIP file)
        async function shareSelectedQRs() {
            const selectedCheckboxes = document.querySelectorAll('.ticket-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                displayMessage('Por favor, selecciona al menos una entrada para compartir.', 'info');
                return;
            }

            const zip = new JSZip();
            const filesToShare = [];

            displayMessage('Preparando QRs para compartir...', 'info');

            for (const checkbox of selectedCheckboxes) {
                const ticketId = checkbox.dataset.ticketId;
                const ticket = ticketsDB[ticketId];
                if (ticket && ticket.qrDataURL) {
                    const blob = await (await fetch(ticket.qrDataURL)).blob();
                    const fileName = `${ticket.name.replace(/[^a-zA-Z0-9]/g, '_')}_${ticketId}.png`;
                    zip.file(fileName, blob);
                    filesToShare.push(new File([blob], fileName, { type: 'image/png' }));
                }
            }

            if (filesToShare.length === 0) {
                displayMessage('No se encontraron QRs válidos para compartir.', 'error');
                return;
            }

            // Try to use Web Share API for multiple files if supported
            if (navigator.share && navigator.canShare({ files: filesToShare })) {
                try {
                    await navigator.share({
                        files: filesToShare,
                        title: 'Entradas VYTMUSIC Seleccionadas',
                        text: 'Aquí tienes las entradas seleccionadas para VYTMUSIC.'
                    });
                    displayMessage('QRs seleccionados compartidos exitosamente.', 'success');
                } catch (error) {
                    console.error('Error al compartir QRs seleccionados:', error);
                    displayMessage('No se pudo compartir los QRs. Generando archivo ZIP...', 'error');
                    // Fallback to ZIP download
                    generateAndZipAndDownload(zip);
                }
            } else {
                displayMessage('Tu navegador no soporta compartir múltiples archivos. Generando archivo ZIP...', 'info');
                generateAndZipAndDownload(zip);
            }
        }

        // Function to generate and download a ZIP file of selected QR codes
        async function downloadSelectedQRs() {
            const selectedCheckboxes = document.querySelectorAll('.ticket-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                displayMessage('Por favor, selecciona al menos una entrada para descargar.', 'info');
                return;
            }

            const zip = new JSZip();
            displayMessage('Preparando QRs para descargar...', 'info');

            for (const checkbox of selectedCheckboxes) {
                const ticketId = checkbox.dataset.ticketId;
                const ticket = ticketsDB[ticketId];
                if (ticket && ticket.qrDataURL) {
                    const blob = await (await fetch(ticket.qrDataURL)).blob();
                    const fileName = `${ticket.name.replace(/[^a-zA-Z0-9]/g, '_')}_${ticketId}.png`;
                    zip.file(fileName, blob);
                }
            }
            generateAndZipAndDownload(zip);
        }

        function generateAndZipAndDownload(zip) {
            zip.generateAsync({ type: "blob" })
                .then(function (content) {
                    saveAs(content, "VYTMUSIC_Entradas_QR.zip");
                    displayMessage('Archivo ZIP de QRs descargado exitosamente.', 'success');
                })
                .catch(error => {
                    console.error('Error al generar el ZIP:', error);
                    displayMessage('Error al generar el archivo ZIP.', 'error');
                });
        }

        // --- QR Scanner Logic (using jsQR) ---

        // Function to start the QR scanner
        async function startQrScanner() {
            stopQrScanner(); // Ensure any existing stream is stopped

            scannedResultDiv.classList.add('hidden');
            ticketStatusDiv.classList.add('hidden');
            markUsedBtn.classList.add('hidden');
            scannedResultDiv.textContent = '';
            ticketStatusDiv.textContent = '';
            
            // Ensure canvas is visible for drawing detection box
            canvasElement.style.display = 'block';

            try {
                // Request camera access
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment", // Prefer rear camera
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                video.srcObject = videoStream;
                video.setAttribute("playsinline", true); // Required for iOS
                
                // Wait for video metadata to load before playing and starting scan
                video.onloadedmetadata = () => {
                    video.play();
                    scanning = true;
                    // Set canvas dimensions to match video after it's loaded
                    canvasElement.width = video.videoWidth;
                    canvasElement.height = video.videoHeight;
                    requestAnimationFrame(tick); // Start scanning loop
                    displayMessage('Escáner de QR iniciado. Apunta la cámara a un código.', 'info');
                };

            } catch (err) {
                let userFriendlyMessage = `Error al iniciar la cámara: ${err.message}.`;
                if (err.name === 'NotAllowedError') {
                    userFriendlyMessage = 'Permiso de cámara denegado. Por favor, permite el acceso a la cámara en la configuración de tu navegador.';
                } else if (err.name === 'NotFoundError') {
                    userFriendlyMessage = 'No se encontró una cámara compatible. Asegúrate de que tu dispositivo tenga una cámara.';
                } else if (err.name === 'NotReadableError' || err.name === 'OverconstrainedError') {
                    userFriendlyMessage = 'La cámara está en uso o no se puede acceder a ella. Cierra otras aplicaciones que puedan estar usando la cámara e inténtalo de nuevo.';
                } else if (err.name === 'AbortError') {
                    userFriendlyMessage = 'La operación de la cámara fue abortada. Esto puede ocurrir si cierras rápidamente la sección o si hay un problema interno.';
                } else if (err.name === 'NotSupportedError') {
                    userFriendlyMessage = 'Tu navegador no soporta la API de la cámara o la configuración solicitada.';
                }
                displayMessage(userFriendlyMessage, 'error');
                console.error('Error accessing camera for scanning:', err);
                scanning = false;
                canvasElement.style.display = 'none'; // Hide canvas if camera fails
            }
        }

        // Function to stop the QR scanner
        function stopQrScanner() {
            scanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                videoStream = null;
            }
            canvas.clearRect(0, 0, canvasElement.width, canvasElement.height); // Clear canvas
            canvasElement.style.display = 'none'; // Hide canvas
        }

        // Drawing function for QR code bounding box
        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }

        // Scanning loop
        function tick() {
            if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
                if (scanning) requestAnimationFrame(tick); // Keep trying if scanning is true but video not ready
                return;
            }

            // Set canvas dimensions dynamically based on video
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;

            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "attemptBoth", // Try both normal and inverted QR codes
            });

            if (code) {
                // QR code found
                drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#00FF00");
                drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#00FF00");
                drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#00FF00");
                drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#00FF00");

                onScanSuccess(code.data);
                stopQrScanner(); // Stop scanning after successful read
            } else {
                // No QR code found, continue scanning
                requestAnimationFrame(tick);
            }
        }

        // Callback function for successful QR scan (from jsQR)
        function onScanSuccess(decodedText) {
            console.log(`QR code detected: ${decodedText}`);
            currentScannedTicketId = decodedText;
            scannedResultDiv.classList.remove('hidden');
            scannedResultDiv.textContent = `Código Escaneado: ${decodedText}`;

            const ticket = ticketsDB[decodedText];

            ticketStatusDiv.classList.remove('hidden');
            markUsedBtn.classList.add('hidden'); // Hide by default

            if (ticket) {
                if (ticket.status === 'valid') {
                    ticketStatusDiv.textContent = `Estado: Válida (${ticket.name})`;
                    ticketStatusDiv.classList.remove('status-used', 'status-invalid');
                    ticketStatusDiv.classList.add('status-valid');
                    markUsedBtn.classList.remove('hidden');
                } else if (ticket.status === 'used') {
                    ticketStatusDiv.textContent = `Estado: Ya Utilizada (${ticket.name})`;
                    ticketStatusDiv.classList.remove('status-valid', 'status-invalid');
                    ticketStatusDiv.classList.add('status-used');
                }
            } else {
                ticketStatusDiv.textContent = 'Estado: Entrada Inválida o No Encontrada';
                ticketStatusDiv.classList.remove('status-valid', 'status-used');
                ticketStatusDiv.classList.add('status-invalid');
            }
        }

        // Function to mark ticket as used
        function markTicketAsUsed() {
            if (currentScannedTicketId && ticketsDB[currentScannedTicketId] && ticketsDB[currentScannedTicketId].status === 'valid') {
                ticketsDB[currentScannedTicketId].status = 'used';
                ticketStatusDiv.textContent = `Estado: Marcada como Usada (${ticketsDB[currentScannedTicketId].name})`;
                ticketStatusDiv.classList.remove('status-valid');
                ticketStatusDiv.classList.add('status-used');
                markUsedBtn.classList.add('hidden');
                console.log('Ticket marcado como usado:', currentScannedTicketId);
                displayMessage('Entrada marcada como usada.', 'success');
            }
        }

        // Función para mostrar mensajes al usuario (reemplazo de alert)
        function displayMessage(message, type) {
            const messageBox = document.createElement('div');
            messageBox.textContent = message;
            messageBox.style.padding = '1rem';
            messageBox.style.borderRadius = '0.5rem';
            messageBox.style.marginTop = '1rem';
            messageBox.style.textAlign = 'center';
            messageBox.style.fontWeight = '600';
            messageBox.style.transition = 'opacity 0.5s ease-out';
            messageBox.style.opacity = '1';
            messageBox.style.position = 'fixed'; // Fixed position
            messageBox.style.top = '20px'; // From top
            messageBox.style.left = '50%'; // Center horizontally
            messageBox.style.transform = 'translateX(-50%)'; // Adjust for centering
            messageBox.style.zIndex = '1000'; // Ensure it's on top
            messageBox.style.minWidth = '300px'; // Minimum width
            messageBox.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)'; // Subtle shadow

            if (type === 'success') {
                messageBox.style.backgroundColor = '#d1fae5'; /* Green 100 */
                messageBox.style.color = '#065f46'; /* Green 800 */
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#fee2e2'; /* Red 100 */
                messageBox.style.color = '#991b1b'; /* Red 800 */
            } else {
                messageBox.style.backgroundColor = '#fef3c7'; /* Yellow 100 */
                messageBox.style.color = '#92400e'; /* Yellow 800 */
            }

            document.body.appendChild(messageBox);

            // Eliminar el mensaje después de un tiempo
            setTimeout(() => {
                messageBox.style.opacity = '0';
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }


        // Event Listeners
        showGeneratorBtn.addEventListener('click', () => switchSection('ticket-generator-section'));
        showBatchGeneratorBtn.addEventListener('click', () => switchSection('batch-ticket-generator-section'));
        showScannerBtn.addEventListener('click', () => switchSection('qr-scanner-section'));
        generateTicketBtn.addEventListener('click', generateIndividualTicket);
        generateBatchTicketsBtn.addEventListener('click', generateBatchTickets);
        markUsedBtn.addEventListener('click', markTicketAsUsed);

        // New event listeners for batch actions
        selectAllQRsBtn.addEventListener('click', toggleSelectAllQRs);
        shareSelectedQRsBtn.addEventListener('click', shareSelectedQRs);
        downloadSelectedQRsBtn.addEventListener('click', downloadSelectedQRs);


        // Initial setup: show generator section by default
        window.onload = () => {
            switchSection('ticket-generator-section');
        };
    </script>
</body>
</html>
