<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Entradas VYTMUSIC</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Mover la configuración de Tailwind después de que el CDN de Tailwind se haya cargado.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Define un color celeste personalizado basado en el logo
                        'vyt-celeste': '#87CEEB', // Un celeste claro, puedes ajustarlo si tienes un código HEX específico del logo
                        'vyt-dark-blue': '#4682B4', // Un azul más oscuro para contrastes
                        'vyt-darker-blue': '#36648B', // Un azul aún más oscuro para el hover
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Fondo negro */
            color: #f7fafc; /* Letras blancas */
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .btn {
            @apply px-4 py-2 rounded-md font-bold transition-colors duration-200;
        }
        .btn-primary {
            @apply bg-vyt-dark-blue text-white hover:bg-vyt-darker-blue;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white hover:bg-gray-700;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
        .input-field {
            @apply w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:border-vyt-celeste;
        }
        .message-box {
            @apply p-4 rounded-md mb-4 text-sm;
        }
        .message-box.success {
            @apply bg-green-500 text-white;
        }
        .message-box.error {
            @apply bg-red-500 text-white;
        }
        .message-box.warning {
            @apply bg-yellow-500 text-white;
        }
        #qr-video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 8px;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .ticket-card {
            @apply bg-gray-800 p-4 rounded-lg shadow-md mb-4 flex items-center justify-between;
        }
        .ticket-card.used {
            @apply opacity-60 line-through;
        }
        .ticket-card .qr-code-display {
            @apply w-24 h-24 bg-white p-1 rounded-md;
        }
        .ticket-card .ticket-info {
            @apply flex-grow ml-4;
        }
        .ticket-card .ticket-actions {
            @apply flex flex-col space-y-2;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #87CEEB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"; // Updated to 11.10.0
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js"; // Updated to 11.10.0
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js"; // Updated to 11.10.0
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"; // Updated to 11.10.0

        // QR Scanner Library
        import { Html5QrcodeScanner } from "https://unpkg.com/html5-qrcode@2.3.8/esm/html5-qrcode-scanner.js";

        let app;
        let db;
        let auth;
        let userId;
        let analytics; // Declare analytics globally
        let isFirebaseReady = false; // Flag to indicate if Firebase is fully initialized and authenticated

        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Use the provided firebaseConfig if __firebase_config is not defined by the Canvas environment
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyC_2Ukoxf_ry7QfKtou1Cz6nY-qTVw4qTU",
            authDomain: "vyt-music.firebaseapp.com",
            projectId: "vyt-music",
            storageBucket: "vyt-music.firebasestorage.app",
            messagingSenderId: "574981837817",
            appId: "1:574981837817:web:a29933a22bbfd51a086328",
            measurementId: "G-8QCQF3HWEJ"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements (declared here, assigned in window.onload)
        let loadingOverlay;
        let messageContainer;
        let qrScannerSection;
        let batchTicketGeneratorSection;
        let scanHistorySection;
        let showBatchGeneratorBtn;
        let showScannerBtn;
        let showHistoryBtn;
        let generateBatchTicketsBtn;
        let numTicketsInput;
        let ticketPrefixInput;
        let generatedTicketsContainer;
        let qrCodeReader;
        let scannedTicketInfo;
        let markUsedBtn;
        let currentScannedTicketId;
        let currentScannedTicketStatus;
        let currentScannedTicketPrefix;
        let scanHistoryList;
        let shareAllTicketsBtn;
        let currentUserIdDisplay;

        let html5QrCodeScanner; // Declare the scanner globally

        // --- Utility Functions ---

        // Function to display messages to the user
        function displayMessage(message, type = 'info') {
            if (!messageContainer) {
                console.error('Message container not initialized.');
                return;
            }
            messageContainer.innerHTML = `<div class="message-box ${type}">${message}</div>`;
            messageContainer.classList.remove('hidden');
            setTimeout(() => {
                messageContainer.classList.add('hidden');
                messageContainer.innerHTML = '';
            }, 5000); // Hide after 5 seconds
        }

        // Function to switch between sections
        function switchSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Stop QR scanner if switching away from scanner section
            if (sectionId !== 'qr-scanner-section' && html5QrCodeScanner) {
                // Attempt to stop any running scanner instance gracefully
                if (html5QrCodeScanner.isScanning()) { // Use isScanning() method
                    html5QrCodeScanner.stop().then(() => {
                        console.log("QR scanner stopped.");
                    }).catch((err) => {
                        console.error("Error stopping QR scanner:", err);
                    });
                }
            } else if (sectionId === 'qr-scanner-section') {
                // Start QR scanner if switching to scanner section
                startQrScanner();
            }

            // Update history if switching to history section
            if (sectionId === 'scan-history-section') {
                loadScanHistory();
            }
        }

        // Function to generate a unique ticket ID
        function generateTicketId(prefix) {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
        }

        // Function to render QR code using qrcode.js
        function renderQRCode(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = ''; // Clear previous QR code
                new QRCode(element, {
                    text: text,
                    width: 96,
                    height: 96,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        // --- Firebase Functions ---

        // Function to save a ticket to Firestore
        async function saveTicket(ticketId, prefix) {
            if (!isFirebaseReady) {
                displayMessage('Firebase no está listo. No se puede guardar el ticket.', 'error');
                return;
            }
            try {
                // Public data: /artifacts/{appId}/public/data/tickets/{ticketId}
                const ticketRef = doc(db, `artifacts/${appId}/public/data/tickets`, ticketId);
                await setDoc(ticketRef, {
                    id: ticketId,
                    prefix: prefix,
                    used: false,
                    generatedAt: new Date().toISOString(),
                    usedAt: null,
                    generatedBy: userId
                });
                displayMessage(`Ticket ${ticketId} generado y guardado.`, 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                displayMessage(`Error al guardar el ticket ${ticketId}: ${e.message}`, 'error');
            }
        }

        // Function to get a ticket from Firestore
        async function getTicket(ticketId) {
            if (!isFirebaseReady) {
                displayMessage('Firebase no está listo. No se puede obtener el ticket.', 'error');
                return null;
            }
            try {
                const ticketRef = doc(db, `artifacts/${appId}/public/data/tickets`, ticketId);
                const ticketSnap = await getDoc(ticketRef);
                if (ticketSnap.exists()) {
                    return ticketSnap.data();
                } else {
                    return null;
                }
            } catch (e) {
                console.error("Error getting document: ", e);
                displayMessage(`Error al obtener el ticket ${ticketId}: ${e.message}`, 'error');
                return null;
            }
        }

        // Function to update a ticket in Firestore
        async function updateTicket(ticketId, data) {
            if (!isFirebaseReady) {
                displayMessage('Firebase no está listo. No se puede actualizar el ticket.', 'error');
                return false;
            }
            try {
                const ticketRef = doc(db, `artifacts/${appId}/public/data/tickets`, ticketId);
                await updateDoc(ticketRef, data);
                displayMessage(`Ticket ${ticketId} actualizado.`, 'success');
                return true;
            } catch (e) {
                console.error("Error updating document: ", e);
                displayMessage(`Error al actualizar el ticket ${ticketId}: ${e.message}`, 'error');
                return false;
            }
        }

        // Function to save a scan event to Firestore (private data)
        async function saveScanEvent(ticketData, scanStatus) {
            if (!isFirebaseReady) {
                displayMessage('Firebase no está listo. No se puede guardar el evento de escaneo.', 'error');
                return;
            }
            try {
                // Private data: /artifacts/{appId}/users/{userId}/scanHistory
                const scanHistoryCollection = collection(db, `artifacts/${appId}/users/${userId}/scanHistory`);
                await addDoc(scanHistoryCollection, {
                    ticketId: ticketData.id,
                    prefix: ticketData.prefix,
                    status: scanStatus, // e.g., 'valid', 'used', 'invalid'
                    scannedAt: new Date().toISOString(),
                    scannedBy: userId,
                    ticketUsed: ticketData.used,
                    ticketGeneratedAt: ticketData.generatedAt,
                    ticketUsedAt: ticketData.usedAt
                });
                console.log("Scan event saved to history.");
            } catch (e) {
                console.error("Error saving scan event: ", e);
                displayMessage(`Error al guardar el evento de escaneo: ${e.message}`, 'error');
            }
        }

        // Function to load scan history from Firestore (private data)
        async function loadScanHistory() {
            if (!isFirebaseReady) {
                displayMessage('Firebase no está listo. No se puede cargar el historial de escaneo.', 'error');
                scanHistoryList.innerHTML = '<li class="text-center text-gray-400">Firebase no está configurado.</li>';
                return;
            }
            scanHistoryList.innerHTML = '<li class="text-center text-gray-400">Cargando historial...</li>';
            try {
                const scanHistoryCollection = collection(db, `artifacts/${appId}/users/${userId}/scanHistory`);
                const q = query(scanHistoryCollection); // No orderBy to avoid index issues
                const querySnapshot = await getDocs(q);

                scanHistoryList.innerHTML = ''; // Clear previous list
                if (querySnapshot.empty) {
                    scanHistoryList.innerHTML = '<li class="text-center text-gray-400">No hay historial de escaneo.</li>';
                    return;
                }

                const historyItems = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    historyItems.push(data);
                });

                // Sort in memory by scannedAt in descending order
                historyItems.sort((a, b) => new Date(b.scannedAt) - new Date(a.scannedAt));

                historyItems.forEach(data => {
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-md mb-2 ${data.status === 'valid' ? 'bg-green-700' : data.status === 'used' ? 'bg-yellow-700' : 'bg-red-700'}`;
                    li.innerHTML = `
                        <p class="font-bold">Ticket ID: ${data.ticketId}</p>
                        <p>Prefijo: ${data.prefix}</p>
                        <p>Estado: <span class="font-semibold">${data.status === 'valid' ? 'Válido' : data.status === 'used' ? 'Usado' : 'Inválido'}</span></p>
                        <p>Escaneado en: ${new Date(data.scannedAt).toLocaleString()}</p>
                        ${data.ticketUsed ? `<p>Usado en: ${new Date(data.ticketUsedAt).toLocaleString()}</p>` : ''}
                    `;
                    scanHistoryList.appendChild(li);
                });
            } catch (e) {
                console.error("Error loading scan history: ", e);
                displayMessage(`Error al cargar el historial de escaneo: ${e.message}`, 'error');
                scanHistoryList.innerHTML = '<li class="text-center text-gray-400">Error al cargar el historial.</li>';
            }
        }


        // --- Event Handlers / Main Logic ---

        // Handles the result from the QR scanner
        async function onScanSuccess(decodedText, decodedResult) {
            console.log(`QR Code detected: ${decodedText}`);
            // Stop the scanner after a successful scan to prevent multiple reads
            html5QrCodeScanner.stop().then(() => {
                console.log("QR scanner stopped after successful scan.");
            }).catch((err) => {
                console.error("Error stopping QR scanner after scan:", err);
            });

            displayMessage(`Código QR escaneado: ${decodedText}`, 'info');

            const ticketData = await getTicket(decodedText);

            if (ticketData) {
                currentScannedTicketId.textContent = ticketData.id;
                currentScannedTicketPrefix.textContent = ticketData.prefix;
                if (ticketData.used) {
                    currentScannedTicketStatus.textContent = 'USADO';
                    currentScannedTicketStatus.className = 'text-red-500 font-bold';
                    markUsedBtn.classList.add('hidden');
                    displayMessage('Este ticket ya ha sido usado.', 'error');
                    saveScanEvent(ticketData, 'used');
                } else {
                    currentScannedTicketStatus.textContent = 'VÁLIDO';
                    currentScannedTicketStatus.className = 'text-green-500 font-bold';
                    markUsedBtn.classList.remove('hidden');
                    displayMessage('Ticket válido. Puedes marcarlo como usado.', 'success');
                    saveScanEvent(ticketData, 'valid');
                }
            } else {
                currentScannedTicketId.textContent = 'N/A';
                currentScannedTicketPrefix.textContent = 'N/A';
                currentScannedTicketStatus.textContent = 'INVÁLIDO';
                currentScannedTicketStatus.className = 'text-red-500 font-bold';
                markUsedBtn.classList.add('hidden');
                displayMessage('Ticket no encontrado o inválido.', 'error');
                // For invalid tickets, we create a dummy object to save to history
                saveScanEvent({ id: decodedText, prefix: 'UNKNOWN', used: false, generatedAt: null, usedAt: null }, 'invalid');
            }
            scannedTicketInfo.classList.remove('hidden');
        }

        function onScanFailure(error) {
            // console.warn(`QR Code scan error: ${error}`); // Too noisy for console
        }

        // Function to start the QR scanner (more robust)
        async function startQrScanner() {
            if (html5QrCodeScanner) {
                try {
                    // Attempt to stop any running scanner instance gracefully
                    if (html5QrCodeScanner.isScanning()) { // Use isScanning() method
                        await html5QrCodeScanner.stop();
                        console.log("Existing QR scanner stopped.");
                    }
                } catch (err) {
                    // Log error but proceed, as stopping might fail if scanner wasn't properly started
                    console.warn("Could not stop existing QR scanner (may not have been running):", err);
                }
            } else {
                // Initialize scanner only once
                html5QrCodeScanner = new Html5QrcodeScanner(
                    "qr-code-reader",
                    { fps: 10, qrbox: { width: 250, height: 250 }, rememberLastUsedCamera: true },
                    /* verbose= */ false
                );
            }

            // Always attempt to render/start the scanner
            try {
                // Render will start the scanning process if not already started
                await html5QrCodeScanner.render(onScanSuccess, onScanFailure);
                console.log("QR scanner started/rendered.");
            } catch (err) {
                console.error("Error starting/rendering QR scanner:", err);
                displayMessage(`Error al iniciar el escáner QR: ${err.message}. Asegúrate de que tu dispositivo tenga cámara y permisos.`, 'error');
            }
        }

        // Function to generate batch tickets
        async function generateBatchTickets() {
            // Ensure inputs are correctly referenced
            if (!numTicketsInput || !ticketPrefixInput) {
                displayMessage('Error: Los campos de entrada no están inicializados. Recarga la página.', 'error');
                console.error('numTicketsInput or ticketPrefixInput is null. DOM elements not found.');
                return;
            }

            const numTickets = parseInt(numTicketsInput.value);
            const ticketPrefix = ticketPrefixInput.value.trim();

            console.log(`Intentando generar ${numTickets} tickets con prefijo "${ticketPrefix}"`); // Debugging log

            if (isNaN(numTickets) || numTickets <= 0) {
                displayMessage('Por favor, introduce un número válido de tickets.', 'warning');
                return;
            }
            if (!ticketPrefix) {
                displayMessage('Por favor, introduce un prefijo para los tickets.', 'warning');
                return;
            }

            generatedTicketsContainer.innerHTML = ''; // Clear previous tickets
            const ticketsToShare = [];

            for (let i = 0; i < numTickets; i++) {
                const ticketId = generateTicketId(ticketPrefix);
                await saveTicket(ticketId, ticketPrefix);

                const ticketCard = document.createElement('div');
                ticketCard.id = `ticket-${ticketId}`;
                ticketCard.className = 'ticket-card';
                ticketCard.innerHTML = `
                    <div class="qr-code-display" id="qr-${ticketId}"></div>
                    <div class="ticket-info">
                        <p class="font-bold text-lg">${ticketPrefix}</p>
                        <p class="text-sm text-gray-400 break-all">${ticketId}</p>
                        <p class="text-sm text-gray-400" id="status-${ticketId}">Estado: <span class="text-green-400">Activo</span></p>
                    </div>
                `;
                generatedTicketsContainer.appendChild(ticketCard);
                renderQRCode(`qr-${ticketId}`, ticketId);
                ticketsToShare.push(ticketId);
            }
            displayMessage(`${numTickets} tickets generados y guardados.`, 'success');

            // Store ticketsToShare in a data attribute or global variable for later use
            shareAllTicketsBtn.dataset.tickets = JSON.stringify(ticketsToShare);
            shareAllTicketsBtn.classList.remove('hidden'); // Show share button
        }

        // Function to mark a scanned ticket as used
        async function markTicketAsUsed() {
            const ticketId = currentScannedTicketId.textContent;
            if (ticketId === 'N/A' || !ticketId) {
                displayMessage('No hay un ticket escaneado para marcar como usado.', 'warning');
                return;
            }

            const success = await updateTicket(ticketId, { used: true, usedAt: new Date().toISOString() });
            if (success) {
                currentScannedTicketStatus.textContent = 'USADO';
                currentScannedTicketStatus.className = 'text-red-500 font-bold';
                markUsedBtn.classList.add('hidden');
                displayMessage(`Ticket ${ticketId} marcado como usado.`, 'success');
                // Update the scan history entry for this ticket
                const ticketData = await getTicket(ticketId); // Get updated data
                if (ticketData) {
                    saveScanEvent(ticketData, 'used'); // Save with updated status
                }
            }
        }

        // Function to share all generated tickets via WhatsApp
        function shareAllTicketsOnWhatsApp() {
            const tickets = JSON.parse(shareAllTicketsBtn.dataset.tickets || '[]');
            if (tickets.length === 0) {
                displayMessage('No hay tickets generados para compartir.', 'warning');
                return;
            }

            let message = "¡Aquí están tus tickets para VYTMUSIC!\n\n";
            tickets.forEach((ticket, index) => {
                message += `Ticket ${index + 1}: ${ticket}\n`;
            });
            message += "\n¡Disfruta del evento!";

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Initialize App on window load
        window.onload = async () => {
            // Assign UI elements here to ensure DOM is ready
            loadingOverlay = document.getElementById('loading-overlay');
            messageContainer = document.getElementById('message-container');
            qrScannerSection = document.getElementById('qr-scanner-section');
            batchTicketGeneratorSection = document.getElementById('batch-ticket-generator-section');
            scanHistorySection = document.getElementById('scan-history-section');
            showBatchGeneratorBtn = document.getElementById('show-batch-generator-btn');
            showScannerBtn = document.getElementById('show-scanner-btn');
            showHistoryBtn = document.getElementById('show-history-btn');
            generateBatchTicketsBtn = document.getElementById('generate-batch-tickets-btn');
            numTicketsInput = document.getElementById('num-tickets');
            ticketPrefixInput = document.getElementById('ticket-prefix');
            generatedTicketsContainer = document.getElementById('generated-tickets-container');
            qrCodeReader = document.getElementById('qr-code-reader');
            scannedTicketInfo = document.getElementById('scanned-ticket-info');
            markUsedBtn = document.getElementById('mark-used-btn');
            currentScannedTicketId = document.getElementById('current-scanned-ticket-id');
            currentScannedTicketStatus = document.getElementById('current-scanned-ticket-status');
            currentScannedTicketPrefix = document.getElementById('current-scanned-ticket-prefix');
            scanHistoryList = document.getElementById('scan-history-list');
            shareAllTicketsBtn = document.getElementById('share-all-tickets-btn');
            currentUserIdDisplay = document.getElementById('current-user-id');

            console.log('UI Elements assigned:', { numTicketsInput, ticketPrefixInput, generateBatchTicketsBtn });

            // Add debug listeners to inputs
            if (numTicketsInput) {
                numTicketsInput.addEventListener('input', (e) => {
                    console.log('Num Tickets Input:', e.target.value);
                });
            }
            if (ticketPrefixInput) {
                ticketPrefixInput.addEventListener('input', (e) => {
                    console.log('Ticket Prefix Input:', e.target.value);
                });
            }
            if (generateBatchTicketsBtn) {
                generateBatchTicketsBtn.addEventListener('click', () => {
                    console.log('Generate Batch Tickets button clicked.');
                });
            }


            loadingOverlay.classList.remove('hidden'); // Show loading overlay initially

            if (firebaseConfig) {
                try {
                    app = initializeApp(firebaseConfig);
                    analytics = getAnalytics(app); // Initialize analytics
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in using custom token if provided, otherwise anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        displayMessage('Autenticación exitosa con token personalizado.', 'success');
                    } else {
                        await signInAnonymously(auth);
                        displayMessage('Autenticación anónima exitosa.', 'success');
                    }

                    // Listen for auth state changes to set userId and readiness flag
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            currentUserIdDisplay.textContent = `ID de Usuario: ${userId}`;
                            isFirebaseReady = true; // Firebase is ready for operations
                            loadingOverlay.classList.add('hidden'); // Hide loading overlay on successful auth
                            switchSection('qr-scanner-section'); // Show scanner after auth
                            // startQrScanner(); // Moved this call into switchSection for better control
                        } else {
                            userId = null; // User signed out or auth fails
                            isFirebaseReady = false; // Firebase not fully ready for operations
                            console.warn("No user authenticated. Functioning in limited mode.");
                            displayMessage('No se pudo autenticar. Algunas funciones pueden estar limitadas.', 'warning');
                            loadingOverlay.classList.add('hidden'); // Hide loading overlay even if auth fails
                            switchSection('qr-scanner-section'); // Fallback to scanner section
                        }
                    });
                } catch (error) {
                    console.error("Error initializing Firebase or signing in:", error);
                    displayMessage(`Error de inicialización de Firebase: ${error.message}. Funcionando en modo limitado.`, 'error');
                    isFirebaseReady = false; // Explicitly set to false if init fails
                    loadingOverlay.classList.add('hidden'); // Hide loading overlay on Firebase init error
                    switchSection('qr-scanner-section'); // Fallback to in-memory if Firebase init fails
                }
            } else {
                console.warn("Firebase config not fully provided. Running in-memory mode (data will not be saved).");
                displayMessage('Configuración de Firebase incompleta. Los datos no se guardarán permanentemente.', 'warning');
                isFirebaseReady = false; // Explicitly set to false for in-memory mode
                loadingOverlay.classList.add('hidden'); // Hide loading overlay if no Firebase config
                switchSection('qr-scanner-section'); // Fallback to in-memory if no Firebase
            }

            // Event Listeners
            showBatchGeneratorBtn.addEventListener('click', () => switchSection('batch-ticket-generator-section'));
            showScannerBtn.addEventListener('click', () => switchSection('qr-scanner-section'));
            showHistoryBtn.addEventListener('click', () => switchSection('scan-history-section'));
            generateBatchTicketsBtn.addEventListener('click', generateBatchTickets);
            markUsedBtn.addEventListener('click', markTicketAsUsed);
            shareAllTicketsBtn.addEventListener('click', shareAllTicketsOnWhatsApp);

            // Initial setup: show scanner section by default (handled after Firebase init)
        };
    </script>
    <!-- qrcode.js library for QR code generation -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="text-white ml-4">Cargando aplicación...</p>
    </div>

    <div class="container mx-auto p-4 flex-grow">
        <h1 class="text-4xl font-bold text-center mb-8 text-vyt-celeste">Control de Entradas VYTMUSIC</h1>

        <!-- Message Container -->
        <div id="message-container" class="hidden"></div>

        <!-- Navigation Buttons -->
        <nav class="flex justify-center space-x-4 mb-8">
            <button id="show-scanner-btn" class="btn btn-primary">Escanear QR</button>
            <button id="show-batch-generator-btn" class="btn btn-primary">Generar Tickets</button>
            <button id="show-history-btn" class="btn btn-primary">Historial de Escaneo</button>
        </nav>

        <p id="current-user-id" class="text-sm text-gray-400 text-center mb-4">ID de Usuario: Cargando...</p>

        <!-- QR Scanner Section -->
        <section id="qr-scanner-section" class="section active bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-vyt-celeste">Escanear Código QR</h2>
            <div id="qr-code-reader" class="w-full h-auto max-w-md mx-auto bg-gray-700 rounded-lg overflow-hidden"></div>

            <div id="scanned-ticket-info" class="hidden mt-6 p-4 bg-gray-700 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">Información del Ticket Escaneado:</h3>
                <p>ID: <span id="current-scanned-ticket-id" class="font-mono break-all"></span></p>
                <p>Prefijo: <span id="current-scanned-ticket-prefix" class="font-semibold"></span></p>
                <p>Estado: <span id="current-scanned-ticket-status" class="font-bold"></span></p>
                <button id="mark-used-btn" class="btn btn-danger mt-4 hidden">Marcar como Usado</button>
            </div>
        </section>

        <!-- Batch Ticket Generator Section -->
        <section id="batch-ticket-generator-section" class="section bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-vyt-celeste">Generar Tickets por Lotes</h2>
            <div class="mb-4">
                <label for="num-tickets" class="block text-sm font-medium text-gray-300 mb-2">Número de Tickets:</label>
                <input type="number" id="num-tickets" class="input-field" placeholder="Ej: 10" value="1">
            </div>
            <div class="mb-6">
                <label for="ticket-prefix" class="block text-sm font-medium text-gray-300 mb-2">Prefijo del Ticket (Ej: VYTMUSIC):</label>
                <input type="text" id="ticket-prefix" class="input-field" placeholder="Ej: VYTMUSIC" value="VYTMUSIC">
            </div>
            <button id="generate-batch-tickets-btn" class="btn btn-primary w-full mb-6">Generar Tickets</button>

            <div id="generated-tickets-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Generated tickets will be appended here -->
            </div>

            <button id="share-all-tickets-btn" class="btn btn-secondary w-full mt-6 hidden">Compartir Todos los Tickets (WhatsApp)</button>
        </section>

        <!-- Scan History Section -->
        <section id="scan-history-section" class="section bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-vyt-celeste">Historial de Escaneo</h2>
            <ul id="scan-history-list" class="space-y-3">
                <!-- Scan history items will be loaded here -->
                <li class="text-center text-gray-400">Cargando historial...</li>
            </ul>
        </section>

    </div>

    <footer class="text-center py-4 text-gray-500 text-sm mt-8">
        © 2024 VYTMUSIC. Todos los derechos reservados.
    </footer>

</body>
</html>
