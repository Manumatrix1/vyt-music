document.addEventListener('DOMContentLoaded', () => {
    // ... (tus variables globales y funciones de utilidad existentes) ...

    const qrCodeScannerSection = document.getElementById('qr-scanner-section');
    const qrCodeReaderContainer = document.getElementById('qr-code-reader-container');
    const scannerStatusMessage = document.getElementById('scanner-status-message');

    let html5QrCode = null; // Para guardar la instancia de Html5Qrcode
    // Rutas de ejemplo para sonidos de éxito y error. ¡Asegúrate de que sean accesibles!
    const SCAN_SUCCESS_SOUND_PATH = 'https://tonejs.github.io/audio/sfx/success_1.mp3';
    const SCAN_FAIL_SOUND_PATH = 'https://tonejs.github.io/audio/sfx/error_1.mp3';
    let successPlayer, failPlayer;

    async function initializeSoundPlayers() {
        try {
            await Tone.start(); // Inicia el contexto de audio
            successPlayer = new Tone.Player(SCAN_SUCCESS_SOUND_PATH).toDestination();
            failPlayer = new Tone.Player(SCAN_FAIL_SOUND_PATH).toDestination();
            await Tone.loaded(); // Espera a que los sonidos se carguen
            console.log("Sonidos cargados correctamente.");
        } catch (error) {
            console.error("Error al inicializar Tone.js o cargar sonidos:", error);
            displayMessage('Error al cargar efectos de sonido.', 'error');
        }
    }

    // Función para reproducir el sonido de escaneo
    function playScanSound(isValid) {
        if (Tone.context.state !== 'running') {
            Tone.start(); // Asegura que el contexto de audio esté corriendo
        }
        if (isValid && successPlayer && successPlayer.loaded) {
            successPlayer.start();
        } else if (!isValid && failPlayer && failPlayer.loaded) {
            failPlayer.start();
        }
    }

    async function startQrScanner() {
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("qr-code-reader");
        }

        const config = {
            fps: 15, // **Clave:** Aumenta los frames por segundo para una detección más rápida (10 o 15).
            qrbox: { width: 250, height: 250 }, // **Clave:** Define una región de escaneo para enfocar la detección.
            rememberLastUsedCamera: true, // Recuerda la última cámara usada.
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA], // Solo usa la cámara para escanear.
            formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE], // **Clave:** Explicitamente busca SOLO códigos QR.
            disableFlip: false, // Puedes probar 'true' si tienes problemas con códigos "invertidos" (raro).
            // Ejemplo de cómo pedir mayor resolución (no siempre soportado por todos los dispositivos):
            // videoConstraints: {
            //     facingMode: "environment", // Prioriza la cámara trasera
            //     width: { ideal: 1280 },    // Pide un ancho ideal
            //     height: { ideal: 720 }    // Pide un alto ideal
            // }
        };

        try {
            scannerStatusMessage.textContent = "Iniciando escáner...";
            qrCodeReaderContainer.classList.add('scanning-active'); // Añade animación de borde

            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length) {
                let cameraId = cameras[0].id; // Usa la primera cámara por defecto

                // **Clave:** Prefiere la cámara trasera si está disponible
                const rearCamera = cameras.find(camera => camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('rear'));
                if (rearCamera) {
                    cameraId = rearCamera.id;
                }

                await html5QrCode.start(
                    cameraId,
                    config,
                    async (decodedText, decodedResult) => {
                        console.log(`QR Code detectado: ${decodedText}`);
                        scannerStatusMessage.textContent = "QR detectado. Procesando...";

                        // Detén el escáner temporalmente para procesar el resultado
                        await html5QrCode.stop();
                        qrCodeReaderContainer.classList.remove('scanning-active');

                        await processScannedQR(decodedText);
                        // Reinicia el escáner después de un breve retraso para evitar escaneos duplicados.
                        setTimeout(() => {
                            if (activeSection === 'qr-scanner-section') { // Solo reinicia si sigue en la sección del escáner
                                startQrScanner();
                            }
                        }, 2000); // Espera 2 segundos antes de reiniciar para que el usuario pueda reaccionar
                    },
                    (errorMessage) => {
                        // console.warn(`QR Code no scan error: ${errorMessage}`); // Descomenta para depurar errores de no escaneo
                        scannerStatusMessage.textContent = "Apunte la cámara a un código QR.";
                    }
                );
                scannerStatusMessage.textContent = "Escáner activo. Apunte a un código QR.";
            } else {
                displayMessage("No se encontraron cámaras compatibles.", 'error');
                scannerStatusMessage.textContent = "Error: No se encontraron cámaras.";
            }
        } catch (err) {
            console.error("Error al iniciar el escáner QR:", err);
            displayMessage(`Error al iniciar el escáner: ${err.message}. Asegúrate de permitir el acceso a la cámara.`, 'error');
            scannerStatusMessage.textContent = `Error al iniciar escáner: ${err.message}`;
            qrCodeReaderContainer.classList.remove('scanning-active');
        }
    }

    async function stopQrScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            try {
                await html5QrCode.stop();
                console.log("Escáner QR detenido.");
                qrCodeReaderContainer.classList.remove('scanning-active');
                scannerStatusMessage.textContent = "Escáner detenido.";
            } catch (err) {
                console.warn("Error al detener el escáner QR:", err);
                // Puede ocurrir si el escáner no se inició completamente o ya estaba detenido.
            }
        }
    }

    async function processScannedQR(qrData) {
        showLoadingOverlay();
        // Simula un retardo para la llamada a la API/procesamiento
        await new Promise(resolve => setTimeout(resolve, 500)); // Simula un retardo de red

        let isValid = false;
        let flashClass = 'invalid';
        let message = 'Código QR inválido o desconocido.';

        try {
            const ticket = JSON.parse(qrData); // Asume que los datos del QR son un JSON del ticket
            const existingTicket = getTicketById(ticket.id);

            if (existingTicket) {
                if (existingTicket.used) {
                    message = `Entrada de ${existingTicket.name} ya ha sido USADA.`;
                    flashClass = 'used';
                    isValid = false;
                    playScanSound(false); // Sonido de error/usada
                } else {
                    existingTicket.used = true;
                    existingTicket.scanTimestamp = new Date().toISOString();
                    saveTicketsToLocalStorage(); // Actualiza el estado del ticket
                    addScanHistoryEntry(existingTicket.id, existingTicket.name, true);
                    updateStats();
                    message = `¡Entrada VÁLIDA para ${existingTicket.name}! Acceso concedido.`;
                    flashClass = 'valid';
                    isValid = true;
                    playScanSound(true); // Sonido de éxito
                }
            } else {
                addScanHistoryEntry(null, qrData, false, 'No registrada');
                message = `Entrada no REGISTRADA en el sistema.`;
                flashClass = 'invalid';
                isValid = false;
                playScanSound(false); // Sonido de error
            }
        } catch (e) {
            console.error("Error al parsear los datos del QR:", e);
            addScanHistoryEntry(null, qrData, false, 'Formato inválido');
            message = `Error en el formato del QR: ${qrData}.`;
            flashClass = 'invalid';
            isValid = false;
            playScanSound(false); // Sonido de error
        } finally {
            hideLoadingOverlay();
            showScanFlash(flashClass);
            displayMessage(message, isValid ? 'success' : 'error');
        }
    }


    // --- Lógica de cambio de sección (Existente) ---
    const navButtons = document.querySelectorAll('.nav-btn');
    let activeSection = 'batch-ticket-generator-section'; // Sección activa por defecto

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');

        navButtons.forEach(button => {
            if (button.dataset.section === sectionId) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });

        activeSection = sectionId; // Actualiza la sección activa

        // Detener escáner al salir de su sección
        if (sectionId !== 'qr-scanner-section') {
            stopQrScanner();
        } else {
            // Iniciar escáner al entrar a su sección
            startQrScanner();
        }
    }

    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            showSection(button.dataset.section);
        });
    });

    // Inicializar los reproductores de sonido cuando el DOM esté listo
    initializeSoundPlayers();

    // Mostrar la sección inicial
    showSection(activeSection); // Muestra la sección activa por defecto al cargar

    // ... (el resto de tu JavaScript existente para generación de tickets, almacenamiento, etc.) ...
});
