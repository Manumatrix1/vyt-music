<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Entradas VYTMUSIC</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Mover la configuración de Tailwind después de que el CDN de Tailwind se haya cargado.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    backgroundImage: {
                        'logo-pattern': "url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgZmlsbD0iIzYzNjZmMSIgb3BhY2l0eT0iMC4wMyIvPjx0ZXh0IHg9IjI1MCIgeT0iMjUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDAiIGZpbGw9IiM2MzY2ZjEiIG9wYWNpdHk9IjAuMiIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPlZ5dG11c2ljPC90ZXh0Pjwvc3ZnPg==')"
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgZmlsbD0iIzYzNjZmMSIgb3BhY2l0eT0iMC4wMyIvPjx0ZXh0IHg9IjI1MCIgeT0iMjUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDAiIGZpbGw9IiM2MzY2ZjEiIG9wYWNpdHk9IjAuMSIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPlZ5dG11c2ljPC90ZXh0Pjwvc3ZnPg==');
            background-size: 300px;
            background-position: center;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGV4dCB4PSIxNTAiIHk9IjE1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgwIiBmaWxsPSIjZjBmMjY1IiBvcGFjaXR5PSIwLjEiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5WTVVTPC90ZXh0Pjwvc3ZnPg==');
            background-size: 200px;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: 0;
        }
        .content-wrapper {
            position: relative;
            z-index: 1;
        }
        .button-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(79, 70, 229, 0.3);
        }
        .button-secondary {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            color: #4f46e5;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.1);
        }
        .button-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(99, 102, 241, 0.15);
        }
        .section-header {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
            padding-bottom: 0.5rem;
        }
        .section-header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #4f46e5);
            border-radius: 2px;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        /* Style for QR code container */
        .qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            min-height: 200px;
            border: 1px solid #e5e7eb;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .qrcode-container img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* QR Scanner specific styles */
        #reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #111827;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        #video-preview {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }
        #qr-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 3px solid #6366f1;
            border-radius: 0.5rem;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
        }
        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #4f46e5;
        }
        .corner-tl {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 0.5rem;
        }
        .corner-tr {
            top: -3px;
            right: -3px;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 0.5rem;
        }
        .corner-bl {
            bottom: -3px;
            left: -3px;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 0.5rem;
        }
        .corner-br {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 0.5rem;
        }
        #scanned-result, #ticket-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
        }
        .status-valid {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .status-used {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }
        .status-invalid {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        .hidden {
            display: none;
        }
        .ticket-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background-color: #f9fafb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
        }
        .ticket-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .share-button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-top: 1rem;
            border: none;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        .share-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }
        .checkbox-container {
            position: absolute;
            top: 10px;
            left: 10px;
        }
        .batch-action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .app-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }
        .app-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px rgba(99, 102, 241, 0.3);
            overflow: hidden;
            border: 4px solid white;
        }
        .app-logo::before {
            content: "VYT";
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            letter-spacing: 1px;
        }
        .app-title {
            font-size: 2.25rem;
            font-weight: 800;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }
        .app-subtitle {
            color: #6b7280;
            font-size: 1.125rem;
            max-width: 500px;
            margin: 0 auto;
        }
        .scanner-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .restart-scanner-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }
        .restart-scanner-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
        }
        .ticket-count {
            background-color: #6366f1;
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .floating-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.5s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
        }
        @keyframes slideIn {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        .notification-success {
            background-color: #10b981;
            color: white;
        }
        .notification-error {
            background-color: #ef4444;
            color: white;
        }
        .notification-info {
            background-color: #3b82f6;
            color: white;
        }
        .notification-warning {
            background-color: #f59e0b;
            color: white;
        }
    </style>
</head>
<body class="font-inter antialiased">
    <div class="container">
        <div class="app-header">
            <div class="app-logo"></div>
            <h1 class="app-title">VYTMUSIC</h1>
            <p class="app-subtitle">Sistema profesional de gestión de entradas con tecnología QR</p>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-center flex-wrap gap-4 mb-8">
            <button id="show-generator-btn" class="button-primary">
                Generar Entrada Individual
                <span id="single-count" class="ticket-count">0</span>
            </button>
            <button id="show-batch-generator-btn" class="button-secondary">
                Generar Múltiples Entradas
                <span id="batch-count" class="ticket-count">0</span>
            </button>
            <button id="show-scanner-btn" class="button-secondary">Escanear Entrada</button>
        </div>

        <!-- Ticket Generator Section (Individual) -->
        <div id="ticket-generator-section" class="p-6 border border-gray-200 rounded-lg shadow-sm bg-white">
            <h2 class="section-header">Generar Nueva Entrada Individual</h2>
            <div class="mb-4">
                <label for="ticket-holder-name" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Titular:</label>
                <input type="text" id="ticket-holder-name" class="input-field" placeholder="Ej: Juan Pérez">
            </div>
            <button id="generate-ticket-btn" class="button-primary w-full">Generar Entrada QR</button>

            <div id="generated-ticket-info" class="mt-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-center hidden">
                <p class="text-indigo-800 font-semibold mb-2">¡Entrada Generada Exitosamente!</p>
                <p class="text-gray-700 text-sm">ID de la Entrada:</p>
                <p id="ticket-id-display" class="text-xl font-bold text-indigo-700 break-words"></p>
                <div id="qrcode-single" class="qrcode-container"></div>
                <button id="share-single-qr-btn" class="share-button">Compartir QR</button>
            </div>
        </div>

        <!-- Batch Ticket Generator Section -->
        <div id="batch-ticket-generator-section" class="p-6 border border-gray-200 rounded-lg shadow-sm bg-white hidden">
            <h2 class="section-header">Generar Múltiples Entradas</h2>
            <div class="mb-4">
                <label for="batch-ticket-names" class="block text-gray-700 text-sm font-bold mb-2">Nombres de los Titulares (uno por línea o separados por comas):</label>
                <textarea id="batch-ticket-names" class="input-field h-32" placeholder="Ej:&#10;Mauro&#10;Ana&#10;Carlos&#10;Sofía"></textarea>
            </div>
            <button id="generate-batch-tickets-btn" class="button-primary w-full">Generar Entradas QR por Lotes</button>

            <div id="generated-batch-tickets-info" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-indigo-700 mb-4 text-center">Entradas Generadas: <span id="generated-count" class="text-indigo-500">0</span></h3>
                <div class="batch-action-buttons">
                    <button id="select-all-qrs-btn" class="button-secondary">Seleccionar Todos</button>
                    <button id="share-selected-qrs-btn" class="share-button">Compartir Seleccionados</button>
                    <button id="download-selected-qrs-btn" class="button-secondary">Descargar Seleccionados</button>
                </div>
                <div id="batch-qrcodes-display" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                    <!-- QR codes will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- QR Scanner Section -->
        <div id="qr-scanner-section" class="p-6 border border-gray-200 rounded-lg shadow-sm bg-white">
            <h2 class="section-header">Escanear Entrada</h2>
            <div id="reader">
                <video id="video-preview" autoplay playsinline></video>
                <canvas id="qr-canvas"></canvas>
                <div class="scanner-overlay">
                    <div class="scanner-frame">
                        <div class="scanner-corner corner-tl"></div>
                        <div class="scanner-corner corner-tr"></div>
                        <div class="scanner-corner corner-bl"></div>
                        <div class="scanner-corner corner-br"></div>
                    </div>
                </div>
            </div>
            <div class="scanner-actions">
                <button id="restart-scanner-btn" class="restart-scanner-btn">Reiniciar Escáner</button>
                <button id="mark-used-btn" class="button-primary hidden">Marcar como Usada</button>
            </div>
            <div id="scanned-result" class="hidden"></div>
            <div id="ticket-status" class="hidden"></div>
        </div>
    </div>

    <!-- QR Code Generator Library -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <!-- jsQR Library for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- JSZip Library for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // In-memory database for tickets (for demonstration purposes only)
        let ticketsDB = {};
        let currentScannedTicketId = null;
        
        let video = document.getElementById('video-preview');
        let canvasElement = document.getElementById('qr-canvas');
        let canvas = canvasElement.getContext('2d');
        let scanning = false;
        let videoStream = null;

        // Global variables for the logo images
        let logoNegro = new Image();
        logoNegro.src = 'uploaded:LOGO NEGRO.jpg-014a468e-dce4-4df6-8bce-a2575e30369c'; 
        logoNegro.onerror = () => console.error("Error al cargar el logo negro.");

        let logoBlanco = new Image();
        logoBlanco.src = 'uploaded:logo blanco.jpg-77eec31c-0e38-4c9f-bfbd-d802a22e026a'; 
        logoBlanco.onerror = () => console.error("Error al cargar el logo blanco.");

        // Wait for both logos to load
        const loadLogosPromise = Promise.all([
            new Promise(resolve => { logoNegro.onload = resolve; }),
            new Promise(resolve => { logoBlanco.onload = resolve; })
        ]);

        // Your phone number
        const VYTMUSIC_PHONE = '34177422062';

        // Get DOM elements
        const showGeneratorBtn = document.getElementById('show-generator-btn');
        const showBatchGeneratorBtn = document.getElementById('show-batch-generator-btn');
        const showScannerBtn = document.getElementById('show-scanner-btn');

        const ticketGeneratorSection = document.getElementById('ticket-generator-section');
        const batchTicketGeneratorSection = document.getElementById('batch-ticket-generator-section');
        const qrScannerSection = document.getElementById('qr-scanner-section');

        const ticketHolderNameInput = document.getElementById('ticket-holder-name');
        const generateTicketBtn = document.getElementById('generate-ticket-btn');
        const generatedTicketInfo = document.getElementById('generated-ticket-info');
        const ticketIdDisplay = document.getElementById('ticket-id-display');
        const qrcodeSingleDiv = document.getElementById('qrcode-single');
        const shareSingleQrBtn = document.getElementById('share-single-qr-btn'); 

        const batchTicketNamesTextarea = document.getElementById('batch-ticket-names');
        const generateBatchTicketsBtn = document.getElementById('generate-batch-tickets-btn');
        const generatedBatchTicketsInfo = document.getElementById('generated-batch-tickets-info');
        const batchQRCodesDisplay = document.getElementById('batch-qrcodes-display');
        const selectAllQRsBtn = document.getElementById('select-all-qrs-btn'); 
        const shareSelectedQRsBtn = document.getElementById('share-selected-qrs-btn'); 
        const downloadSelectedQRsBtn = document.getElementById('download-selected-qrs-btn'); 
        const generatedCountSpan = document.getElementById('generated-count');

        const scannedResultDiv = document.getElementById('scanned-result');
        const ticketStatusDiv = document.getElementById('ticket-status');
        const markUsedBtn = document.getElementById('mark-used-btn');
        const restartScannerBtn = document.getElementById('restart-scanner-btn');
        const singleCountSpan = document.getElementById('single-count');
        const batchCountSpan = document.getElementById('batch-count');

        // Function to hide all sections and stop scanner
        function hideAllSections() {
            ticketGeneratorSection.classList.add('hidden');
            batchTicketGeneratorSection.classList.add('hidden');
            qrScannerSection.classList.add('hidden');
            stopQrScanner();
        }

        // Function to reset button styles
        function resetButtonStyles() {
            showGeneratorBtn.classList.add('button-secondary');
            showGeneratorBtn.classList.remove('button-primary');
            showBatchGeneratorBtn.classList.add('button-secondary');
            showBatchGeneratorBtn.classList.remove('button-primary');
            showScannerBtn.classList.add('button-secondary');
            showScannerBtn.classList.remove('button-primary');
        }

        // Function to switch between sections
        function switchSection(sectionId) {
            hideAllSections();
            resetButtonStyles();

            if (sectionId === 'ticket-generator-section') {
                ticketGeneratorSection.classList.remove('hidden');
                showGeneratorBtn.classList.add('button-primary');
            } else if (sectionId === 'batch-ticket-generator-section') {
                batchTicketGeneratorSection.classList.remove('hidden');
                showBatchGeneratorBtn.classList.add('button-primary');
            } else if (sectionId === 'qr-scanner-section') {
                qrScannerSection.classList.remove('hidden');
                showScannerBtn.classList.add('button-primary');
                startQrScanner();
            }
        }

        // Function to generate a unique ticket ID
        function generateUniqueTicketId() {
            return 'VYTMUSIC-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        // Function to create a composite QR image with details
        async function createCompositeQrImage(ticketId, name, isBatch = false) {
            const qrText = ticketId;

            // Wait for logos to load before proceeding
            await loadLogosPromise;

            // Create a temporary canvas for the composite image
            const compositeCanvas = document.createElement('canvas');
            const compositeCtx = compositeCanvas.getContext('2d');

            // Define dimensions for the composite image
            const logoHeight = 80;
            const qrSize = isBatch ? 150 : 200;
            const textLineHeight = 20;
            const padding = 15;
            const marginBetweenElements = 10;

            const canvasWidth = Math.max(qrSize + padding * 2, 300);
            const canvasHeight = logoHeight + marginBetweenElements + (textLineHeight * 2) + marginBetweenElements + qrSize + marginBetweenElements + textLineHeight + padding * 2;

            compositeCanvas.width = canvasWidth;
            compositeCanvas.height = canvasHeight;

            // Draw background with subtle gradient
            const gradient = compositeCtx.createLinearGradient(0, 0, canvasWidth, canvasHeight);
            gradient.addColorStop(0, '#f9fafb');
            gradient.addColorStop(1, '#e5e7eb');
            compositeCtx.fillStyle = gradient;
            compositeCtx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Draw decorative elements
            compositeCtx.fillStyle = '#6366f1';
            compositeCtx.globalAlpha = 0.1;
            compositeCtx.beginPath();
            compositeCtx.arc(0, 0, 100, 0, Math.PI * 2);
            compositeCtx.fill();
            
            compositeCtx.beginPath();
            compositeCtx.arc(canvasWidth, canvasHeight, 120, 0, Math.PI * 2);
            compositeCtx.fill();
            compositeCtx.globalAlpha = 1;

            let currentY = padding;

            // Draw VYTMUSIC logo text
            compositeCtx.fillStyle = '#1f2937';
            compositeCtx.font = 'bold 20px Inter, sans-serif';
            compositeCtx.textAlign = 'center';
            compositeCtx.fillText('VYTMUSIC', canvasWidth / 2, currentY + 25);

            // Draw decorative line under logo
            compositeCtx.beginPath();
            compositeCtx.moveTo(canvasWidth * 0.3, currentY + 35);
            compositeCtx.lineTo(canvasWidth * 0.7, currentY + 35);
            compositeCtx.strokeStyle = '#6366f1';
            compositeCtx.lineWidth = 2;
            compositeCtx.stroke();

            currentY += logoHeight + marginBetweenElements;

            // 1. Draw Logo
            // Choose which logo to draw. For now, we'll use logoNegro.
            // You can add logic here to choose logoBlanco based on context if needed.
            const logoToDraw = logoNegro; // Default to black logo
            // const logoToDraw = logoBlanco; // Uncomment to use white logo

            if (logoToDraw.complete && logoToDraw.naturalHeight !== 0) {
                const logoAspectRatio = logoToDraw.width / logoToDraw.height;
                const drawLogoHeight = logoHeight;
                const drawLogoWidth = drawLogoHeight * logoAspectRatio;
                const drawLogoX = (canvasWidth - drawLogoWidth) / 2;
                compositeCtx.drawImage(logoToDraw, drawLogoX, currentY, drawLogoWidth, drawLogoHeight);
                currentY += drawLogoHeight + marginBetweenElements;
            } else {
                // Fallback if logo not loaded (should be rare now with Promise.all)
                console.warn("Logo no cargado, usando texto de fallback.");
                compositeCtx.fillStyle = '#1f2937';
                compositeCtx.font = 'bold 20px Inter, sans-serif';
                compositeCtx.textAlign = 'center';
                compositeCtx.fillText('VYTMUSIC', canvasWidth / 2, currentY + logoHeight / 2);
                currentY += logoHeight + marginBetweenElements;
            }

            // 2. Draw Ticket Holder Name
            compositeCtx.fillStyle = '#1f2937'; // Gray 900
            compositeCtx.font = 'bold 18px Inter, sans-serif';
            compositeCtx.textAlign = 'center';
            compositeCtx.fillText(`Titular: ${name}`, canvasWidth / 2, currentY);
            currentY += textLineHeight;

            // 3. Draw Ticket ID
            compositeCtx.font = '14px Inter, sans-serif';
            compositeCtx.fillText(`ID: ${ticketId}`, canvasWidth / 2, currentY);
            currentY += textLineHeight + marginBetweenElements;

            // 4. Draw QR Code
            const qrTempDiv = document.createElement('div');
            new QRCode(qrTempDiv, {
                text: qrText,
                width: qrSize,
                height: qrSize,
                colorDark: "#000000",
                colorLight: "transparent",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Wait for QR code to render to temp div
            await new Promise(resolve => setTimeout(resolve, 100));
            const qrImageElement = qrTempDiv.querySelector('canvas') || qrTempDiv.querySelector('img');
            if (qrImageElement) {
                const qrX = (canvasWidth - qrSize) / 2;
                compositeCtx.fillStyle = '#ffffff';
                compositeCtx.fillRect(qrX - 5, currentY - 5, qrSize + 10, qrSize + 10);
                compositeCtx.drawImage(qrImageElement, qrX, currentY, qrSize, qrSize);
                currentY += qrSize + marginBetweenElements;
            }

            // 5. Draw Phone Number
            compositeCtx.font = 'bold 16px Inter, sans-serif';
            compositeCtx.fillStyle = '#6366f1'; // Indigo 500
            compositeCtx.fillText(`Tel: ${VYTMUSIC_PHONE}`, canvasWidth / 2, currentY);
            currentY += textLineHeight;

            // Draw decorative border
            compositeCtx.strokeStyle = '#d1d5db';
            compositeCtx.lineWidth = 1;
            compositeCtx.strokeRect(1, 1, canvasWidth - 2, canvasHeight - 2);

            return compositeCanvas.toDataURL('image/png');
        }

        // Function to generate a single QR code and update DB
        async function createAndDisplayTicket(name, containerElement, isBatch = false) {
            const ticketId = generateUniqueTicketId();
            const finalQrDataURL = await createCompositeQrImage(ticketId, name, isBatch);
            
            // Store ticket data including the composite QR image data URL
            ticketsDB[ticketId] = {
                status: 'valid',
                name: name,
                qrDataURL: finalQrDataURL
            };

            // Clear previous QR code if it's a single generation
            if (containerElement === qrcodeSingleDiv) {
                containerElement.innerHTML = '';
            }

            // Create a new div for the QR code and text
            const ticketCard = document.createElement('div');
            ticketCard.className = 'ticket-card text-center';
            ticketCard.dataset.ticketId = ticketId;

            if (isBatch) {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'ticket-checkbox w-5 h-5 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500';
                checkbox.dataset.ticketId = ticketId;
                checkbox.checked = true;
                checkboxContainer.appendChild(checkbox);
                ticketCard.appendChild(checkboxContainer);
            }

            const namePara = document.createElement('p');
            namePara.className = 'text-lg font-semibold text-gray-800 mb-2 mt-4';
            namePara.textContent = `Titular: ${name}`;

            const idPara = document.createElement('p');
            idPara.className = 'text-sm text-gray-600 mb-2 break-words';
            idPara.textContent = `ID: ${ticketId}`;

            const qrImage = document.createElement('img');
            qrImage.src = finalQrDataURL;
            qrImage.alt = `QR Code for ${name}`;
            qrImage.style.width = isBatch ? '150px' : '200px';
            qrImage.style.height = isBatch ? '150px' : '200px';
            qrImage.className = 'mx-auto';

            const shareButton = document.createElement('button');
            shareButton.className = 'share-button';
            shareButton.textContent = 'Compartir QR';
            shareButton.onclick = () => shareQrCode(ticketId);


            ticketCard.appendChild(namePara);
            ticketCard.appendChild(idPara);
            ticketCard.appendChild(qrImage);
            ticketCard.appendChild(shareButton);

            containerElement.appendChild(ticketCard);

            console.log('Ticket generado:', ticketsDB[ticketId]);
            return ticketId;
        }

        // Function to update ticket counts display
        function updateTicketCounts() {
            const singleTickets = Object.values(ticketsDB).filter(ticket => 
                !document.querySelector(`.ticket-card[data-ticket-id="${ticket.id}"] .checkbox-container`)
            ).length;
            
            const batchTickets = Object.values(ticketsDB).length - singleTickets;
            
            singleCountSpan.textContent = singleTickets;
            batchCountSpan.textContent = batchTickets;
        }

        // Function to handle individual ticket generation
        async function generateIndividualTicket() {
            const ticketHolderName = ticketHolderNameInput.value.trim();
            if (!ticketHolderName) {
                displayMessage('Por favor, ingresa el nombre del titular de la entrada.', 'error');
                return;
            }

            const generatedId = await createAndDisplayTicket(ticketHolderName, qrcodeSingleDiv);
            ticketIdDisplay.textContent = generatedId;
            generatedTicketInfo.classList.remove('hidden');
            ticketHolderNameInput.value = '';
            displayMessage('¡Entrada Generada Exitosamente!', 'success');

            // Update the onclick handler for the main single share button with the correct ID
            shareSingleQrBtn.onclick = () => shareQrCode(generatedId);
        }

        // Function to handle batch ticket generation
        async function generateBatchTickets() {
            const namesInput = batchTicketNamesTextarea.value.trim();
            if (!namesInput) {
                displayMessage('Por favor, ingresa al menos un nombre para generar entradas.', 'error');
                return;
            }

            // Split names by newline or comma, filter empty strings
            const names = namesInput.split(/[\n,]+/).map(name => name.trim()).filter(name => name.length > 0);

            if (names.length === 0) {
                displayMessage('No se encontraron nombres válidos para generar entradas.', 'error');
                return;
            }

            batchQRCodesDisplay.innerHTML = ''; // Clear previous batch QRs
            let generatedCount = 0;

            for (const name of names) { // Use for...of with await
                await createAndDisplayTicket(name, batchQRCodesDisplay, true); // Pass true for isBatch
                generatedCount++;
            }

            generatedBatchTicketsInfo.classList.remove('hidden');
            batchTicketNamesTextarea.value = ''; // Clear textarea
            displayMessage(`¡Se generaron ${generatedCount} entradas exitosamente!`, 'success');
        }

        // Function to share a single QR code (now always shares the composite image)
        async function shareQrCode(ticketId) {
            const ticket = ticketsDB[ticketId];
            if (!ticket || !ticket.qrDataURL) {
                displayMessage('Error: QR no encontrado para compartir.', 'error');
                return;
            }

            // Convert data URL to Blob for sharing
            const blob = await (await fetch(ticket.qrDataURL)).blob();
            const file = new File([blob], `${ticket.name}_${ticketId}.png`, { type: 'image/png' });

            if (navigator.share && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: `Entrada VYTMUSIC para ${ticket.name}`,
                        text: `Aquí tienes tu entrada para VYTMUSIC. ID: ${ticketId}`
                    });
                    displayMessage('QR compartido exitosamente.', 'success');
                } catch (error) {
                    console.error('Error al compartir QR:', error);
                    displayMessage('No se pudo compartir el QR. Intenta descargarlo.', 'error');
                    // Fallback to download if sharing fails
                    saveAs(file, `${ticket.name}_${ticketId}.png`);
                }
            } else {
                displayMessage('Tu navegador no soporta la función de compartir. Descargando el QR...', 'info');
                saveAs(file, `${ticket.name}_${ticketId}.png`);
            }
        }

        // Function to select/deselect all checkboxes
        function toggleSelectAllQRs() {
            const checkboxes = document.querySelectorAll('.ticket-checkbox');
            const allSelected = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => {
                cb.checked = !allSelected;
            });
        }

        // Function to share selected QR codes (as a ZIP file)
        async function shareSelectedQRs() {
            const selectedCheckboxes = document.querySelectorAll('.ticket-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                displayMessage('Por favor, selecciona al menos una entrada para compartir.', 'info');
                return;
            }

            const zip = new JSZip();
            const filesToShare = [];

            displayMessage('Preparando QRs para compartir...', 'info');

            for (const checkbox of selectedCheckboxes) {
                const ticketId = checkbox.dataset.ticketId;
                const ticket = ticketsDB[ticketId];
                if (ticket && ticket.qrDataURL) {
                    const blob = await (await fetch(ticket.qrDataURL)).blob();
                    const fileName = `${ticket.name.replace(/[^a-zA-Z0-9]/g, '_')}_${ticketId}.png`;
                    zip.file(fileName, blob);
                    filesToShare.push(new File([blob], fileName, { type: 'image/png' }));
                }
            }

            if (filesToShare.length === 0) {
                displayMessage('No se encontraron QRs válidos para compartir.', 'error');
                return;
            }

            // Try to use Web Share API for multiple files if supported
            if (navigator.share && navigator.canShare({ files: filesToShare })) {
                try {
                    await navigator.share({
                        files: filesToShare,
                        title: 'Entradas VYTMUSIC Seleccionadas',
                        text: 'Aquí tienes las entradas seleccionadas para VYTMUSIC.'
                    });
                    displayMessage('QRs seleccionados compartidos exitosamente.', 'success');
                } catch (error) {
                    console.error('Error al compartir QRs seleccionados:', error);
                    displayMessage('No se pudo compartir los QRs. Generando archivo ZIP...', 'error');
                    // Fallback to download
                    generateAndZipAndDownload(zip);
                }
            } else {
                displayMessage('Tu navegador no soporta compartir múltiples archivos. Generando archivo ZIP...', 'info');
                generateAndZipAndDownload(zip);
            }
        }

        // Function to generate and download a ZIP file of selected QR codes
        async function downloadSelectedQRs() {
            const selectedCheckboxes = document.querySelectorAll('.ticket-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                displayMessage('Por favor, selecciona al menos una entrada para descargar.', 'info');
                return;
            }

            const zip = new JSZip();
            displayMessage('Preparando QRs para descargar...', 'info');

            for (const checkbox of selectedCheckboxes) {
                const ticketId = checkbox.dataset.ticketId;
                const ticket = ticketsDB[ticketId];
                if (ticket && ticket.qrDataURL) {
                    const blob = await (await fetch(ticket.qrDataURL)).blob();
                    const fileName = `${ticket.name.replace(/[^a-zA-Z0-9]/g, '_')}_${ticketId}.png`;
                    zip.file(fileName, blob);
                }
            }
            generateAndZipAndDownload(zip);
        }

        function generateAndZipAndDownload(zip) {
            zip.generateAsync({ type: "blob" })
                .then(function (content) {
                    saveAs(content, "VYTMUSIC_Entradas_QR.zip");
                    displayMessage('Archivo ZIP de QRs descargado exitosamente.', 'success');
                })
                .catch(error => {
                    console.error('Error al generar el ZIP:', error);
                    displayMessage('Error al generar el archivo ZIP.', 'error');
                });
        }

        // --- QR Scanner Logic (using jsQR) ---

        // Function to start the QR scanner
        async function startQrScanner() {
            stopQrScanner(); // Ensure any existing stream is stopped

            scannedResultDiv.classList.add('hidden');
            ticketStatusDiv.classList.add('hidden');
            markUsedBtn.classList.add('hidden');
            scannedResultDiv.textContent = '';
            ticketStatusDiv.textContent = '';
            
            // Ensure canvas is visible for drawing detection box
            canvasElement.style.display = 'block';

            try {
                // Request camera access
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment", // Prefer rear camera
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                video.srcObject = videoStream;
                video.setAttribute("playsinline", true); // Required for iOS
                
                // Wait for video metadata to load before playing and starting scan
                video.onloadedmetadata = () => {
                    video.play();
                    scanning = true;
                    // Set canvas dimensions to match video after it's loaded
                    canvasElement.width = video.videoWidth;
                    canvasElement.height = video.videoHeight;
                    requestAnimationFrame(tick); // Start scanning loop
                    displayMessage('Escáner de QR iniciado. Apunta la cámara a un código.', 'info');
                };

            } catch (err) {
                let userFriendlyMessage = `Error al iniciar la cámara: ${err.message}.`;
                if (err.name === 'NotAllowedError') {
                    userFriendlyMessage = 'Permiso de cámara denegado. Por favor, permite el acceso a la cámara en la configuración de tu navegador.';
                } else if (err.name === 'NotFoundError') {
                    userFriendlyMessage = 'No se encontró una cámara compatible. Asegúrate de que tu dispositivo tenga una cámara.';
                } else if (err.name === 'NotReadableError' || err.name === 'OverconstrainedError') {
                    userFriendlyMessage = 'La cámara está en uso o no se puede acceder a ella. Cierra otras aplicaciones que puedan estar usando la cámara e inténtalo de nuevo.';
                } else if (err.name === 'AbortError') {
                    userFriendlyMessage = 'La operación de la cámara fue abortada. Esto puede ocurrir si cierras rápidamente la sección o si hay un problema interno.';
                } else if (err.name === 'NotSupportedError') {
                    userFriendlyMessage = 'Tu navegador no soporta la API de la cámara o la configuración solicitada.';
                }
                displayMessage(userFriendlyMessage, 'error');
                console.error('Error accessing camera for scanning:', err);
                scanning = false;
                canvasElement.style.display = 'none'; // Hide canvas if camera fails
            }
        }

        // Function to stop the QR scanner
        function stopQrScanner() {
            scanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                videoStream = null;
            }
            canvas.clearRect(0, 0, canvasElement.width, canvasElement.height); // Clear canvas
            canvasElement.style.display = 'none'; // Hide canvas
        }

        // Drawing function for QR code bounding box
        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }

        // Scanning loop
        function tick() {
            if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
                if (scanning) requestAnimationFrame(tick); // Keep trying if scanning is true but video not ready
                return;
            }

            // Set canvas dimensions dynamically based on video
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;

            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "attemptBoth", // Try both normal and inverted QR codes
            });

            if (code) {
                // QR code found
                drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#00FF00");
                drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#00FF00");
                drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#00FF00");
                drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#00FF00");

                onScanSuccess(code.data);
                stopQrScanner(); // Stop scanning after successful read
            } else {
                // No QR code found, continue scanning
                requestAnimationFrame(tick);
            }
        }

        // Callback function for successful QR scan (from jsQR)
        function onScanSuccess(decodedText) {
            console.log(`QR code detected: ${decodedText}`);
            currentScannedTicketId = decodedText;
            scannedResultDiv.classList.remove('hidden');
            scannedResultDiv.textContent = `Código Escaneado: ${decodedText}`;

            const ticket = ticketsDB[decodedText];

            ticketStatusDiv.classList.remove('hidden');
            markUsedBtn.classList.add('hidden'); // Hide by default

            if (ticket) {
                if (ticket.status === 'valid') {
                    ticketStatusDiv.textContent = `Estado: Válida (${ticket.name})`;
                    ticketStatusDiv.classList.remove('status-used', 'status-invalid');
                    ticketStatusDiv.classList.add('status-valid');
                    markUsedBtn.classList.remove('hidden');
                } else if (ticket.status === 'used') {
                    ticketStatusDiv.textContent = `Estado: Ya Utilizada (${ticket.name})`;
                    ticketStatusDiv.classList.remove('status-valid', 'status-invalid');
                    ticketStatusDiv.classList.add('status-used');
                }
            } else {
                ticketStatusDiv.textContent = 'Estado: Entrada Inválida o No Encontrada';
                ticketStatusDiv.classList.remove('status-valid', 'status-used');
                ticketStatusDiv.classList.add('status-invalid');
            }
        }

        // Function to mark ticket as used
        function markTicketAsUsed() {
            if (currentScannedTicketId && ticketsDB[currentScannedTicketId] && ticketsDB[currentScannedTicketId].status === 'valid') {
                ticketsDB[currentScannedTicketId].status = 'used';
                ticketStatusDiv.textContent = `Estado: Marcada como Usada (${ticketsDB[currentScannedTicketId].name})`;
                ticketStatusDiv.classList.remove('status-valid');
                ticketStatusDiv.classList.add('status-used');
                markUsedBtn.classList.add('hidden');
                console.log('Ticket marcado como usado:', currentScannedTicketId);
                displayMessage('Entrada marcada como usada.', 'success');
            }
        }

        // Función para mostrar mensajes al usuario (reemplazo de alert)
        function displayMessage(message, type) {
            const messageBox = document.createElement('div');
            messageBox.textContent = message;
            messageBox.className = `floating-notification notification-${type}`;
            document.body.appendChild(messageBox);

            // Eliminar el mensaje después de un tiempo
            setTimeout(() => {
                messageBox.remove();
            }, 3000); // Matches CSS animation duration
        }


        // Event Listeners
        showGeneratorBtn.addEventListener('click', () => switchSection('ticket-generator-section'));
        showBatchGeneratorBtn.addEventListener('click', () => switchSection('batch-ticket-generator-section'));
        showScannerBtn.addEventListener('click', () => switchSection('qr-scanner-section'));
        generateTicketBtn.addEventListener('click', generateIndividualTicket);
        generateBatchTicketsBtn.addEventListener('click', generateBatchTickets);
        markUsedBtn.addEventListener('click', markTicketAsUsed);
        restartScannerBtn.addEventListener('click', startQrScanner); // Added restart scanner button listener

        // New event listeners for batch actions
        selectAllQRsBtn.addEventListener('click', toggleSelectAllQRs);
        shareSelectedQRsBtn.addEventListener('click', shareSelectedQRs);
        downloadSelectedQRsBtn.addEventListener('click', downloadSelectedQRs);


        // Initial setup: show generator section by default
        window.onload = () => {
            switchSection('ticket-generator-section');
        };
    </script>
</body>
</html>
