<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Entradas VYTMUSIC v2</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Libraries with defer for performance -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" defer></script>

    <style>
        /* Custom base styles for body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #f9fafb; /* Light text */
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        /* Section display control */
        .section { display: none; }
        .section.active { display: block; }
        .hidden { display: none !important; }
        
        /* Navigation button styling */
        .nav-btn {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            color: #d1d5db; /* Gray text for inactive */
        }
        .nav-btn.active {
            border-bottom-color: #38bdf8; /* Sky blue for active */
            color: #38bdf8;
        }

        /* Loading Overlay styling */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.3s ease;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #38bdf8;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* QR Scanner container styling */
        #qr-code-reader {
            width: 100%; max-width: 500px; margin: 20px auto;
            border: 2px solid #374151; /* Dark gray border */
            border-radius: 0.5rem; overflow: hidden;
        }
        /* Ensure video feed fills the container */
        #qr-code-reader video { 
            width: 100% !important; 
            height: auto !important; 
        }

        /* Scan result flash overlay */
        .scan-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1100; pointer-events: none; opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        .scan-flash.valid { background-color: rgba(74, 222, 128, 0.5); } /* Green for valid */
        .scan-flash.invalid { background-color: rgba(248, 113, 113, 0.5); } /* Red for invalid */
        .scan-flash.used { background-color: rgba(250, 204, 21, 0.5); } /* Yellow for used */

        /* Modal styling */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 900;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #1f2937; /* Darker gray background */
            padding: 1.5rem; border-radius: 0.5rem;
            max-width: 90%; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 640px) {
            .nav-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .nav-btn {
                width: 100%;
                text-align: center;
                padding: 0.75rem 0;
            }
            .ticket-card {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Overlays and Modals -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>
    <div id="scan-flash-overlay" class="scan-flash"></div>
    <div id="confirmation-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirmar Acción</h3>
            <p id="modal-body" class="mb-6">¿Estás seguro de que deseas continuar?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        
        <header class="text-center mb-6">
            <picture>
                <source srcset="https://raw.githubusercontent.com/vytmusic/vyt-music/main/LOGO%20NEGRO.webp" type="image/webp">
                <img src="https://raw.githubusercontent.com/vytmusic/vyt-music/main/LOGO%20NEGRO.jpg" alt="VYTMUSIC Logo" class="mx-auto mb-4 bg-white rounded-full" style="max-width: 150px;" onerror="this.onerror=null;this.src='https://placehold.co/150x150/ffffff/000000?text=Logo';">
            </picture>
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">VYTMUSIC</h1>
            <p class="text-lg text-gray-300">Control de Entradas v2</p>
            <p class="text-xs text-gray-500 mt-2">ID de Usuario: <span id="current-user-id-display">Cargando...</span></p>
        </header>

        <div id="message-container" class="mb-4"></div>

        <nav class="flex justify-center space-x-2 sm:space-x-4 mb-8 border-b border-gray-700 nav-buttons">
            <button data-section="qr-scanner-section" class="nav-btn px-4 py-2 font-semibold transition-colors">Escanear QR</button>
            <button data-section="batch-ticket-generator-section" class="nav-btn px-4 py-2 font-semibold transition-colors">Generar Entradas</button>
            <button data-section="scan-history-section" class="nav-btn px-4 py-2 font-semibold transition-colors">Historial</button>
        </nav>

        <main>
            <!-- QR Scanner Section -->
            <section id="qr-scanner-section" class="section">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-bold mb-4 text-center">Escanear Código QR</h2>
                    <div id="qr-code-reader"></div>
                    <div class="text-center">
                        <button id="restart-scan-btn" class="hidden mt-4 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Escanear de Nuevo</button>
                    </div>
                    <div id="scanned-ticket-info" class="hidden mt-6 bg-gray-900 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Información de la Entrada</h3>
                        <p><strong>ID:</strong> <span id="current-scanned-ticket-id" class="break-all"></span></p>
                        <p><strong>Prefijo:</strong> <span id="current-scanned-ticket-prefix"></span></p>
                        <p><strong>Nombre:</strong> <span id="current-scanned-ticket-name"></span></p>
                        <p><strong>Estado:</strong> <span id="current-scanned-ticket-status"></span></p>
                        <div class="mt-4 text-center">
                            <button id="mark-used-btn" class="hidden w-full px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Marcar como Usado</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Batch Ticket Generator Section -->
            <section id="batch-ticket-generator-section" class="section">
                <form id="generator-form" class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-bold mb-4">Generar Entradas en Lote</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="ticket-prefix-input" class="block mb-1 font-semibold text-gray-300">Prefijo (ej: VIP, GENERAL)</label>
                            <input type="text" id="ticket-prefix-input" placeholder="VIP2025" required 
                                   class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500"
                                   aria-label="Prefijo para las entradas">
                        </div>
                        <div>
                            <label for="batch-ticket-names-input" class="block mb-1 font-semibold text-gray-300">Nombres (uno por línea o separados por coma)</label>
                            <textarea id="batch-ticket-names-input" rows="5" placeholder="Juan Perez, Maria Gonzalez, ..." required 
                                    class="w-full p-3 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500"
                                    aria-label="Nombres para las entradas"></textarea>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="w-full px-4 py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">Generar</button>
                            <button type="reset" class="w-full px-4 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700">Limpiar</button>
                        </div>
                    </div>
                    <div id="generated-tickets-container" class="mt-6 space-y-4"></div>
                </form>
            </section>

            <!-- Scan History Section -->
            <section id="scan-history-section" class="section">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-4 sm:space-y-0">
                        <h2 class="text-2xl font-bold">Historial de Escaneos</h2>
                        <input type="text" id="history-search" placeholder="Buscar..." 
                               class="p-2 rounded-md border border-gray-600 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-sky-500 w-full sm:w-auto"
                               aria-label="Buscar en historial">
                    </div>
                    <ul id="scan-history-list" class="space-y-3" aria-live="polite">
                        <li class="text-center text-gray-400">Cargando historial...</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        // These are essential for Firebase initialization and user authentication
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vytmusic-default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_FIREBASE_API_KEY", // Replace with actual key if not using Canvas environment
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Main class for the Ticket System application.
         * Manages UI, Firebase interactions, QR scanning, and PDF generation.
         */
        class TicketSystem {
            constructor() {
                // Application configuration
                this.config = {
                    appId: appId,
                    firebase: firebaseConfig,
                    logoUrl: 'https://raw.githubusercontent.com/vytmusic/vyt-music/main/LOGO%20NEGRO.jpg'
                };

                // Application state
                this.state = {
                    currentScannedTicketId: null,
                    logoImage: new Image(), // Used for PDF generation
                    isFirebaseReady: false, // Flag to indicate Firebase is initialized and authenticated
                    unsubscribeFunctions: [], // Stores Firestore unsubscribe functions
                    qrScanner: null, // Html5QrcodeScanner instance
                    userId: null // Current authenticated user ID
                };

                // Cached UI elements for efficient access
                this.uiElements = {};
                this.init();
            }

            /**
             * Initializes the application by caching UI elements, setting up event listeners,
             * loading the logo, initializing Firebase, and setting up history search.
             */
            async init() {
                this.cacheUIElements();
                this.setupEventListeners();
                this.loadLogo();
                await this.initializeFirebase();
                this.setupHistorySearch();
                // Start with the QR scanner section active
                this.switchSection('qr-scanner-section');
            }

            /**
             * Caches frequently used DOM elements to avoid repeated lookups.
             */
            cacheUIElements() {
                const elements = [
                    'loading-overlay', 'scan-flash-overlay', 'confirmation-modal', 'modal-title', 'modal-body',
                    'modal-cancel-btn', 'modal-confirm-btn', 'current-user-id-display', 'message-container',
                    'qr-scanner-section', 'batch-ticket-generator-section', 'scan-history-section',
                    'qr-code-reader', 'restart-scan-btn', 'scanned-ticket-info', 'current-scanned-ticket-id',
                    'current-scanned-ticket-prefix', 'current-scanned-ticket-name', 'current-scanned-ticket-status',
                    'mark-used-btn', 'generator-form', 'ticket-prefix-input', 'batch-ticket-names-input',
                    'generated-tickets-container', 'scan-history-list', 'history-search'
                ];
                
                elements.forEach(id => {
                    const key = id.replace(/-(\w)/g, (_, c) => c.toUpperCase()); // Convert kebab-case to camelCase
                    this.uiElements[key] = document.getElementById(id);
                });
                
                this.uiElements.navButtons = document.querySelectorAll('.nav-btn');
            }

            /**
             * Sets up all global and section-specific event listeners.
             */
            setupEventListeners() {
                // Navigation buttons
                this.uiElements.navButtons.forEach(btn => {
                    btn.addEventListener('click', () => this.switchSection(btn.dataset.section));
                });

                // Ticket generator form submission
                this.uiElements.generatorForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleGenerateTickets();
                });

                // Mark as Used button for scanned tickets
                this.uiElements.markUsedBtn.addEventListener('click', () => this.handleMarkAsUsed());
                // Restart Scan button in QR scanner section
                this.uiElements.restartScanBtn.addEventListener('click', () => this.startQrScanner());

                // Modal action buttons
                this.uiElements.modalCancelBtn.addEventListener('click', () => {
                    this.uiElements.confirmationModal.classList.add('hidden');
                });
            }

            /**
             * Sets up the search functionality for the scan history.
             */
            setupHistorySearch() {
                this.uiElements.historySearch.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const items = this.uiElements.scanHistoryList.querySelectorAll('li');
                    
                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        // Show/hide list items based on search term
                        item.classList.toggle('hidden', !text.includes(term));
                    });
                });
            }

            /**
             * Loads the VYTMUSIC logo image for use in PDF generation.
             * Includes error handling for image loading.
             */
            loadLogo() {
                this.state.logoImage.crossOrigin = "Anonymous"; // Required for canvas operations
                this.state.logoImage.src = this.config.logoUrl;
                this.state.logoImage.onerror = () => {
                    console.error("Error al cargar el logo. Usando placeholder.");
                    this.state.logoImage.src = 'https://placehold.co/150x150/ffffff/000000?text=Logo'; // Fallback
                };
            }

            /**
             * Initializes Firebase services (Auth and Firestore) and authenticates the user.
             * Uses the global `__initial_auth_token` if available, otherwise signs in anonymously.
             */
            async initializeFirebase() {
                this.setLoading(true);
                try {
                    const app = initializeApp(this.config.firebase);
                    // Assign Firebase instances to this.firebase immediately after initialization
                    this.firebase = { 
                        app: app,
                        auth: getAuth(app),
                        db: getFirestore(app)
                    };

                    // Listen for authentication state changes
                    onAuthStateChanged(this.firebase.auth, async (user) => {
                        if (user) {
                            this.state.userId = user.uid;
                            this.uiElements.currentUserIdDisplay.textContent = user.uid;
                            this.state.isFirebaseReady = true;
                            // Load history once Firebase is ready and user is authenticated
                            this.loadScanHistory(); 
                        } else {
                            // If no user, sign in anonymously
                            await signInAnonymously(this.firebase.auth);
                        }
                        this.setLoading(false);
                    });

                    // If an initial auth token is provided (from Canvas environment), use it
                    if (initialAuthToken) {
                        await signInWithCustomToken(this.firebase.auth, initialAuthToken);
                    } else {
                        // If no custom token, ensure anonymous sign-in happens
                        await signInAnonymously(this.firebase.auth);
                    }

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.displayMessage("Error al conectar con el servidor. Por favor, recarga la página.", "error");
                    this.setLoading(false);
                }
            }

            /**
             * Switches the active section of the application.
             * Manages the state of the QR scanner (starts/stops it) based on the active section.
             * @param {string} sectionId - The ID of the section to activate.
             */
            switchSection(sectionId) {
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                // Deactivate all navigation buttons
                this.uiElements.navButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-sky-400');
                    btn.classList.add('text-gray-300');
                });

                // Show the selected section
                const activeSection = this.uiElements[sectionId.replace(/-(\w)/g, (_, c) => c.toUpperCase())];
                if (activeSection) {
                    activeSection.classList.add('active');
                    // Activate the corresponding navigation button
                    const activeNavBtn = document.querySelector(`[data-section="${sectionId}"]`);
                    if (activeNavBtn) {
                        activeNavBtn.classList.add('active', 'text-sky-400');
                        activeNavBtn.classList.remove('text-gray-300');
                    }
                }

                // Manage QR scanner state
                if (sectionId === 'qr-scanner-section') {
                    this.startQrScanner();
                } else {
                    this.stopQrScanner();
                }
            }

            /**
             * Starts the QR code scanner.
             * Initializes Html5QrcodeScanner and begins scanning.
             */
            async startQrScanner() {
                this.uiElements.scannedTicketInfo.classList.add('hidden');
                this.uiElements.restartScanBtn.classList.add('hidden');
                this.displayMessage("Iniciando escáner QR...", "info");

                // Ensure previous scanner instance is stopped and cleared
                if (this.state.qrScanner) {
                    await this.stopQrScanner();
                }

                // Initialize Html5QrcodeScanner
                this.state.qrScanner = new Html5QrcodeScanner(
                    "qr-code-reader",
                    { fps: 10, qrbox: { width: 250, height: 250 }, disableFlip: false },
                    /* verbose= */ false
                );

                // Render the scanner
                this.state.qrScanner.render(
                    this.onScanSuccess.bind(this),
                    this.onScanError.bind(this)
                );
            }

            /**
             * Stops the QR code scanner.
             * Clears the scanner and hides related UI elements.
             */
            async stopQrScanner() {
                if (this.state.qrScanner) {
                    try {
                        await this.state.qrScanner.stop();
                        this.state.qrScanner.clear();
                        this.state.qrScanner = null;
                        console.log("QR Scanner stopped and cleared.");
                    } catch (error) {
                        console.warn("Error stopping QR scanner:", error);
                    }
                }
                this.uiElements.restartScanBtn.classList.remove('hidden');
            }

            /**
             * Callback function for successful QR code scans.
             * Fetches ticket information from Firestore and updates the UI.
             * @param {string} decodedText - The text decoded from the QR code.
             * @param {Object} decodedResult - The full result object from the scanner.
             */
            async onScanSuccess(decodedText, decodedResult) {
                this.stopQrScanner(); // Stop scanner after a successful scan
                this.setLoading(true);
                this.state.currentScannedTicketId = decodedText; // Store the scanned ID

                try {
                    if (!this.state.isFirebaseReady || !this.firebase.db) {
                        this.displayMessage("Firebase no está listo. Intenta de nuevo más tarde.", "error");
                        this.setLoading(false);
                        return;
                    }

                    // Reference to the public tickets collection
                    const ticketRef = doc(this.firebase.db, `artifacts/${this.config.appId}/public/data/tickets`, decodedText);
                    const ticketSnap = await getDoc(ticketRef);

                    this.uiElements.scannedTicketInfo.classList.remove('hidden');
                    this.uiElements.markUsedBtn.classList.add('hidden'); // Hide by default

                    if (ticketSnap.exists()) {
                        const ticketData = ticketSnap.data();
                        this.uiElements.currentScannedTicketId.textContent = decodedText;
                        this.uiElements.currentScannedTicketPrefix.textContent = ticketData.prefix;
                        this.uiElements.currentScannedTicketName.textContent = ticketData.name;

                        if (ticketData.used) {
                            this.uiElements.currentScannedTicketStatus.textContent = "USADO";
                            this.uiElements.currentScannedTicketStatus.className = "font-bold text-yellow-500";
                            this.displayMessage("Entrada ya ha sido usada.", "warning");
                            this.flashScanResult('used');
                        } else {
                            this.uiElements.currentScannedTicketStatus.textContent = "VÁLIDO";
                            this.uiElements.currentScannedTicketStatus.className = "font-bold text-green-500";
                            this.uiElements.markUsedBtn.classList.remove('hidden'); // Show mark as used button
                            this.displayMessage("Entrada válida.", "success");
                            this.flashScanResult('valid');
                        }
                    } else {
                        this.uiElements.currentScannedTicketId.textContent = decodedText;
                        this.uiElements.currentScannedTicketPrefix.textContent = "N/A";
                        this.uiElements.currentScannedTicketName.textContent = "N/A";
                        this.uiElements.currentScannedTicketStatus.textContent = "INVÁLIDO";
                        this.uiElements.currentScannedTicketStatus.className = "font-bold text-red-500";
                        this.displayMessage("Entrada no encontrada o inválida.", "error");
                        this.flashScanResult('invalid');
                    }
                } catch (error) {
                    console.error("Error al procesar el escaneo:", error);
                    this.displayMessage("Error al procesar el escaneo. Intenta de nuevo.", "error");
                    this.flashScanResult('invalid');
                } finally {
                    this.setLoading(false);
                }
            }

            /**
             * Callback function for QR code scan errors.
             * @param {string} errorMessage - The error message from the scanner.
             */
            onScanError(errorMessage) {
                // console.warn("QR Scan Error:", errorMessage); // Log errors for debugging
            }

            /**
             * Handles the generation of multiple tickets from user input.
             * Creates unique IDs, saves tickets to Firestore, generates QR codes, and creates a PDF.
             */
            async handleGenerateTickets() {
                this.setLoading(true);
                const prefix = this.uiElements.ticketPrefixInput.value.trim();
                const namesInput = this.uiElements.batchTicketNamesInput.value.trim();

                if (!prefix || !namesInput) {
                    this.displayMessage("Por favor, completa todos los campos.", "warning");
                    this.setLoading(false);
                    return;
                }

                const names = namesInput.split(/[\n,]+/).map(name => name.trim()).filter(name => name.length > 0);
                if (names.length === 0) {
                    this.displayMessage("Por favor, introduce al menos un nombre.", "warning");
                    this.setLoading(false);
                    return;
                }

                if (!this.state.isFirebaseReady || !this.firebase.db) {
                    this.displayMessage("Firebase no está listo. Intenta de nuevo más tarde.", "error");
                    this.setLoading(false);
                    return;
                }

                this.uiElements.generatedTicketsContainer.innerHTML = ''; // Clear previous tickets
                const generatedTickets = [];

                try {
                    for (const name of names) {
                        const ticketId = this.generateTicketId(prefix, name);
                        const ticketData = {
                            id: ticketId,
                            prefix: prefix,
                            name: name,
                            used: false,
                            generatedBy: this.state.userId,
                            generatedAt: serverTimestamp()
                        };

                        // Save ticket to Firestore in the public collection
                        const ticketDocRef = doc(this.firebase.db, `artifacts/${this.config.appId}/public/data/tickets`, ticketId);
                        await setDoc(ticketDocRef, ticketData);
                        generatedTickets.push(ticketData);

                        // Display generated ticket with QR code
                        const ticketCard = document.createElement('div');
                        ticketCard.className = 'ticket-card bg-gray-900 p-4 rounded-lg flex items-center space-x-4 shadow-md';
                        ticketCard.innerHTML = `
                            <div id="qr-${ticketId}" class="p-2 bg-white rounded-md"></div>
                            <div>
                                <p class="text-lg font-semibold">${name}</p>
                                <p class="text-gray-400 text-sm">Prefijo: ${prefix}</p>
                                <p class="text-gray-400 text-sm break-all">ID: ${ticketId}</p>
                            </div>
                        `;
                        this.uiElements.generatedTicketsContainer.appendChild(ticketCard);
                        this.generateQRCode(ticketId, `qr-${ticketId}`);
                    }
                    this.displayMessage(`Se generaron ${generatedTickets.length} entradas exitosamente.`, "success");
                    this.generatePdfWithQRCodes(generatedTickets); // Generate PDF after all tickets are saved
                } catch (error) {
                    console.error("Error al generar entradas:", error);
                    this.displayMessage("Error al generar entradas. Consulta la consola para más detalles.", "error");
                } finally {
                    this.setLoading(false);
                }
            }

            /**
             * Generates a unique ticket ID.
             * @param {string} prefix - The prefix for the ticket.
             * @param {string} name - The name associated with the ticket.
             * @returns {string} A unique ticket ID.
             */
            generateTicketId(prefix, name) {
                // Simple UUID-like generation for uniqueness
                return `${prefix.toUpperCase()}-${name.replace(/\s/g, '').toUpperCase()}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            }

            /**
             * Generates a QR code for a given ID and renders it into a specified HTML element.
             * @param {string} id - The data to encode in the QR code (ticket ID).
             * @param {string} elementId - The ID of the HTML element where the QR code will be rendered.
             */
            generateQRCode(id, elementId) {
                try {
                    new QRCode(document.getElementById(elementId), {
                        text: id,
                        width: 90,
                        height: 90,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } catch (error) {
                    console.error(`Error generating QR code for ${elementId}:`, error);
                }
            }

            /**
             * Generates a PDF document containing all the generated tickets with their QR codes.
             * @param {Array<Object>} ticketData - An array of ticket objects to include in the PDF.
             */
            async generatePdfWithQRCodes(ticketData) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 10;
                let yOffset = margin;
                const cardHeight = 50; // Height of each ticket card in PDF
                const cardWidth = pageWidth - (2 * margin);
                const qrSize = 40; // Size of QR code in PDF

                doc.setFont('Inter', 'normal'); // Set font for PDF

                for (let i = 0; i < ticketData.length; i++) {
                    const ticket = ticketData[i];
                    const qrCanvasId = `qr-${ticket.id}`;
                    const qrCanvas = document.getElementById(qrCanvasId);

                    if (yOffset + cardHeight > pageHeight - margin && i > 0) {
                        doc.addPage();
                        yOffset = margin;
                    }

                    // Draw ticket card background
                    doc.setFillColor(31, 41, 55); // #1f2937 (gray-800)
                    doc.roundedRect(margin, yOffset, cardWidth, cardHeight, 3, 3, 'F');

                    // Add logo
                    if (this.state.logoImage.complete && this.state.logoImage.naturalWidth > 0) {
                        try {
                            const logoX = margin + 5;
                            const logoY = yOffset + 5;
                            const logoWidth = 20;
                            const logoHeight = 20;
                            doc.addImage(this.state.logoImage, 'JPEG', logoX, logoY, logoWidth, logoHeight);
                        } catch (e) {
                            console.error("Error adding logo to PDF:", e);
                        }
                    }

                    // Add VYTMUSIC text
                    doc.setFontSize(16);
                    doc.setTextColor(56, 189, 248); // #38bdf8 (sky-400)
                    doc.text("VYTMUSIC", margin + 30, yOffset + 15);

                    // Add ticket details
                    doc.setFontSize(10);
                    doc.setTextColor(249, 250, 251); // #f9fafb (white)
                    doc.text(`Nombre: ${ticket.name}`, margin + 30, yOffset + 25);
                    doc.text(`Prefijo: ${ticket.prefix}`, margin + 30, yOffset + 30);
                    doc.text(`ID: ${ticket.id}`, margin + 30, yOffset + 35);

                    // Add QR code image from canvas
                    if (qrCanvas) {
                        try {
                            const qrCodeDataUrl = qrCanvas.querySelector('canvas').toDataURL('image/png');
                            doc.addImage(qrCodeDataUrl, 'PNG', pageWidth - margin - qrSize - 5, yOffset + 5, qrSize, qrSize);
                        } catch (e) {
                            console.error("Error adding QR code to PDF:", e);
                        }
                    }

                    yOffset += cardHeight + margin; // Move to next position
                }

                doc.save('entradas_vytmusic.pdf');
                this.displayMessage("PDF de entradas generado y descargado.", "info");
            }

            /**
             * Handles marking a scanned ticket as 'used' in Firestore.
             * Prompts for confirmation before updating the ticket status.
             */
            async handleMarkAsUsed() {
                if (!this.state.currentScannedTicketId) {
                    this.displayMessage("No hay ninguna entrada escaneada para marcar.", "warning");
                    return;
                }

                this.showConfirmationModal(
                    "Confirmar Uso de Entrada",
                    `¿Estás seguro de que quieres marcar la entrada con ID "${this.state.currentScannedTicketId}" como USADA? Esta acción no se puede deshacer.`,
                    async () => {
                        this.setLoading(true);
                        try {
                            if (!this.state.isFirebaseReady || !this.firebase.db) {
                                this.displayMessage("Firebase no está listo. Intenta de nuevo más tarde.", "error");
                                this.setLoading(false);
                                return;
                            }

                            const ticketRef = doc(this.firebase.db, `artifacts/${this.config.appId}/public/data/tickets`, this.state.currentScannedTicketId);
                            const ticketSnap = await getDoc(ticketRef);

                            if (ticketSnap.exists() && !ticketSnap.data().used) {
                                await setDoc(ticketRef, { used: true, usedBy: this.state.userId, usedAt: serverTimestamp() }, { merge: true });
                                // Add scan record to history (private collection for the user)
                                const historyCollectionRef = collection(this.firebase.db, `artifacts/${this.config.appId}/users/${this.state.userId}/scanHistory`);
                                await addDoc(historyCollectionRef, {
                                    ticketId: this.state.currentScannedTicketId,
                                    status: 'used',
                                    timestamp: serverTimestamp(),
                                    scannedBy: this.state.userId,
                                    name: ticketSnap.data().name,
                                    prefix: ticketSnap.data().prefix
                                });

                                this.uiElements.currentScannedTicketStatus.textContent = "USADO";
                                this.uiElements.currentScannedTicketStatus.className = "font-bold text-yellow-500";
                                this.uiElements.markUsedBtn.classList.add('hidden'); // Hide button after use
                                this.displayMessage("Entrada marcada como USADA exitosamente.", "success");
                                this.flashScanResult('used');
                            } else if (ticketSnap.exists() && ticketSnap.data().used) {
                                this.displayMessage("Esta entrada ya ha sido marcada como USADA.", "warning");
                                this.flashScanResult('used');
                            } else {
                                this.displayMessage("Error: La entrada no existe o no se pudo encontrar.", "error");
                                this.flashScanResult('invalid');
                            }
                        } catch (error) {
                            console.error("Error al marcar entrada como usada:", error);
                            this.displayMessage("Error al marcar entrada como usada. Intenta de nuevo.", "error");
                            this.flashScanResult('invalid');
                        } finally {
                            this.setLoading(false);
                        }
                    }
                );
            }

            /**
             * Loads and displays the scan history from Firestore for the current user.
             * Uses onSnapshot for real-time updates.
             */
            loadScanHistory() {
                if (!this.state.isFirebaseReady || !this.firebase.db || !this.state.userId) {
                    // console.log("Firebase not ready or userId not available for history loading.");
                    return;
                }

                // Unsubscribe from previous listeners to prevent memory leaks
                this.cleanup();

                const historyCollectionRef = collection(this.firebase.db, `artifacts/${this.config.appId}/users/${this.state.userId}/scanHistory`);
                const q = query(historyCollectionRef); // No orderBy to avoid index issues

                // Set up real-time listener
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    this.uiElements.scanHistoryList.innerHTML = ''; // Clear current list
                    if (snapshot.empty) {
                        this.uiElements.scanHistoryList.innerHTML = '<li class="text-center text-gray-400">No hay historial de escaneos.</li>';
                        return;
                    }

                    const historyItems = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        historyItems.push({ id: doc.id, ...data });
                    });

                    // Sort in memory by timestamp (descending)
                    historyItems.sort((a, b) => {
                        const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                        const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                        return timeB - timeA;
                    });

                    historyItems.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-900 p-3 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center';
                        const statusColor = item.status === 'used' ? 'text-yellow-400' : 'text-green-400';
                        const timestampText = item.timestamp ? this.formatTimestamp(item.timestamp.toDate()) : 'Fecha desconocida';

                        li.innerHTML = `
                            <div>
                                <p class="font-semibold text-white">${item.name} (${item.prefix})</p>
                                <p class="text-gray-400 text-sm break-all">ID: ${item.ticketId}</p>
                            </div>
                            <div class="mt-2 sm:mt-0 sm:text-right">
                                <p class="${statusColor} font-bold">${item.status.toUpperCase()}</p>
                                <p class="text-gray-500 text-xs">${timestampText}</p>
                            </div>
                        `;
                        this.uiElements.scanHistoryList.appendChild(li);
                    });
                }, (error) => {
                    console.error("Error fetching scan history:", error);
                    this.displayMessage("Error al cargar el historial de escaneos.", "error");
                });

                this.state.unsubscribeFunctions.push(unsubscribe); // Store unsubscribe function
            }

            /**
             * Displays a custom confirmation modal.
             * @param {string} title - The title of the modal.
             * @param {string} body - The message body of the modal.
             * @param {Function} onConfirm - Callback function to execute when confirmed.
             */
            showConfirmationModal(title, body, onConfirm) {
                this.uiElements.modalTitle.textContent = title;
                this.uiElements.modalBody.textContent = body;
                this.uiElements.confirmationModal.classList.remove('hidden');

                // Clear previous confirm listeners to prevent multiple executions
                const confirmBtn = this.uiElements.modalConfirmBtn;
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                this.uiElements.modalConfirmBtn = newConfirmBtn; // Update cached element

                this.uiElements.modalConfirmBtn.addEventListener('click', () => {
                    this.uiElements.confirmationModal.classList.add('hidden');
                    onConfirm();
                });
            }

            /**
             * Shows a visual flash overlay to indicate scan result (valid, invalid, used).
             * @param {'valid'|'invalid'|'used'} type - The type of scan result.
             */
            flashScanResult(type) {
                const overlay = this.uiElements.scanFlashOverlay;
                overlay.classList.remove('valid', 'invalid', 'used');
                overlay.classList.add(type);
                overlay.style.opacity = '1';

                setTimeout(() => {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        overlay.classList.remove(type);
                    }, 500); // Wait for transition to complete before hiding
                }, 200); // Flash duration
            }

            /**
             * Displays a temporary message to the user.
             * @param {string} message - The message to display.
             * @param {'success'|'error'|'warning'|'info'} type - The type of message.
             */
            displayMessage(message, type = 'success') {
                const colors = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-black',
                    info: 'bg-sky-500 text-white'
                };
                
                this.uiElements.messageContainer.innerHTML = `
                    <div class="p-4 rounded-md mb-4 text-sm font-semibold ${colors[type]}" role="alert">
                        ${message}
                    </div>
                `;
                
                setTimeout(() => {
                    this.uiElements.messageContainer.innerHTML = '';
                }, 5000); // Message disappears after 5 seconds
            }

            /**
             * Shows or hides the global loading spinner.
             * @param {boolean} show - True to show, false to hide.
             */
            setLoading(show) {
                this.uiElements.loadingOverlay.classList.toggle('hidden', !show);
            }

            /**
             * Cleans up any active Firestore real-time listeners.
             * Prevents memory leaks when switching sections or on app shutdown.
             */
            cleanup() {
                this.state.unsubscribeFunctions.forEach(fn => fn());
                this.state.unsubscribeFunctions = [];
            }

            /**
             * Formats a Date object into a readable string.
             * @param {Date} date - The date object to format.
             * @returns {string} Formatted date string.
             */
            formatTimestamp(date) {
                if (!(date instanceof Date)) {
                    return 'Fecha inválida';
                }
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('es-ES', options);
            }
        }

        // Initialize the TicketSystem when the DOM is fully loaded and required libraries are available.
        document.addEventListener('DOMContentLoaded', () => {
            // Check if all external libraries are loaded before initializing
            const checkLibraries = () => {
                if (window.Html5QrcodeScanner && window.QRCode && window.jspdf) {
                    new TicketSystem();
                } else {
                    // If not all libraries are loaded, wait and retry.
                    // This handles cases where defer attribute might cause slight delays.
                    setTimeout(() => {
                        if (window.Html5QrcodeScanner && window.QRCode && window.jspdf) {
                            new TicketSystem();
                        } else {
                            // If libraries still not loaded after retry, show critical error.
                            document.body.innerHTML = `
                                <div class="fixed inset-0 bg-gray-900 flex items-center justify-center p-4">
                                    <div class="bg-gray-800 p-6 rounded-lg max-w-md text-center">
                                        <h2 class="text-2xl font-bold text-red-500 mb-4">Error crítico</h2>
                                        <p class="mb-4">No se pudieron cargar los recursos necesarios. Por favor recarga la página.</p>
                                        <button onclick="window.location.reload()" class="px-4 py-2 bg-sky-600 text-white rounded hover:bg-sky-700">
                                            Recargar
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    }, 1000); // Retry after 1 second
                }
            };
            checkLibraries();
        });
    </script>
</body>
</html>
